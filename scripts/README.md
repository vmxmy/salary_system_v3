# 薪资数据对比工具

这是一个用于对比新老薪资系统数据的工具集，可以验证系统迁移的准确性。

## 功能特性

- 🔍 **单员工对比**：对比指定员工在特定薪资周期的数据
- 📊 **详细报告**：生成包含应发、扣发、实发金额的对比报告
- 💰 **精确计算**：支持到分的精确金额对比
- 📁 **多格式输出**：控制台显示 + JSON详细报告
- ⚡ **并行查询**：同时查询新老系统，提高效率

## 快速开始

### 1. 安装依赖

```bash
cd scripts
npm install
```

### 2. 配置数据库连接

```bash
# 复制配置文件模板
cp .env.example .env

# 编辑.env文件，填入真实的数据库连接信息
nano .env
```

### 3. 运行对比

```bash
# 基本用法：对比指定员工的薪资数据
node payroll-comparison.js <员工姓名> <薪资周期>

# 示例：对比汪琳在2025年1月的薪资数据
node payroll-comparison.js 汪琳 2025-01
```

## 使用示例

### 单员工数据对比

```bash
# 对比汪琳2025年1月的薪资数据
npm run compare 汪琳 2025-01

# 对比韩霜2025年1月的薪资数据  
npm run compare 韩霜 2025-01
```

### 输出示例

```
================================================================================
📊 薪资数据对比报告
================================================================================
👤 员工姓名: 汪琳
📅 薪资周期: 2025-01
🕐 对比时间: 2025/1/29 14:32:47
================================================================================

📈 数据对比结果:
--------------------------------------------------------------------------------
应发合计: ✅
  老系统: ¥20,724.00
  新系统: ¥20,724.00
  差　异: ¥0.00 (0.00%)

扣发合计: ✅
  老系统: ¥6,662.87
  新系统: ¥6,662.87
  差　异: ¥0.00 (0.00%)

实发合计: ✅
  老系统: ¥14,061.13
  新系统: ¥14,061.13
  差　异: ¥0.00 (0.00%)

================================================================================
🎯 整体匹配: ✅ 完全一致
================================================================================
📄 详细报告已保存: ../reports/payroll-comparison-汪琳-2025-01-2025-01-29.json
```

## 详细报告格式

每次对比会生成JSON格式的详细报告，包含：

```json
{
  "metadata": {
    "employee_name": "汪琳",
    "pay_period": "2025-01",
    "comparison_date": "2025-01-29T06:32:47.123Z",
    "report_version": "1.0"
  },
  "old_system": {
    "full_name": "汪琳",
    "id_number": "510103197108310040",
    "gross_pay": 20724.00,
    "total_deductions": 6662.87,
    "net_pay": 14061.13,
    // ... 更多老系统数据
  },
  "new_system": {
    "full_name": "汪琳", 
    "id_number": "510103197108310040",
    "gross_pay": 20724.00,
    "total_deductions": 6662.87,
    "net_pay": 14061.13,
    // ... 更多新系统数据
  },
  "comparison": {
    "gross_pay": {
      "old_value": 20724.00,
      "new_value": 20724.00,
      "difference": 0.00,
      "match": true,
      "percentage_diff": "0.00"
    },
    // ... 其他对比结果
    "overall_match": true
  }
}
```

## 可用脚本

```json
{
  "scripts": {
    "compare": "node payroll-comparison.js",
    "test": "node test-comparison.js",
    "batch-compare": "node batch-comparison.js"
  }
}
```

## 数据库连接配置

### 老系统数据库（PostgreSQL）
- 服务器：`8.137.160.207:5432`
- 数据库名：`salary_system`
- 主要表：`payroll.payroll_entries`, `hr.employees`
- 查询字段：应发工资、扣发合计、实发工资

### 新系统数据库（Supabase）  
- 项目：`rjlymghylrshudywrzec`
- URL：`https://rjlymghylrshudywrzec.supabase.co`
- 主要表：`payrolls`, `employees`
- 查询字段：gross_pay, total_deductions, net_pay
- 连接方式：Supabase JavaScript 客户端

## 错误处理

工具包含完善的错误处理机制：

- 🔌 **数据库连接错误**：自动重试和友好提示
- 📝 **参数验证**：检查员工姓名和薪资周期格式
- 🔍 **数据缺失**：明确提示哪个系统缺少数据
- 💾 **文件写入错误**：自动创建报告目录

## 注意事项

1. **数据库权限**：确保数据库用户有读取权限
2. **网络连接**：确保能连接到老系统和Supabase数据库
3. **薪资周期格式**：必须使用 `YYYY-MM` 格式（如：2025-01）
4. **员工姓名匹配**：姓名必须与数据库中完全一致
5. **时区处理**：所有时间都使用本地时区显示

## 故障排除

### 连接失败
```bash
# 测试老系统数据库连接
psql -h localhost -U postgres -d salary_system_v2

# 测试新系统数据库连接  
psql -h db.bcflefwvvpozqhzapzxl.supabase.co -U postgres -d postgres
```

### 找不到员工数据
- 检查员工姓名拼写是否正确
- 确认该员工在指定薪资周期是否有薪资记录
- 验证薪资周期格式（YYYY-MM）

### 数据不匹配
- 检查两个系统的数据是否同步
- 确认计算规则是否一致
- 查看详细的JSON报告了解具体差异

## 技术架构

- **Node.js**: 运行环境
- **pg**: PostgreSQL客户端库
- **并行查询**: 使用Promise.all同时查询两个数据库
- **事务安全**: 每个查询使用独立连接，避免冲突
- **内存优化**: 查询后立即关闭连接，避免内存泄漏

## 开发者信息

- 开发团队：Salary System Team
- 版本：1.0.0
- 许可证：MIT
- 更新日期：2025-01-29