name: Deploy Docker Container to Private Server

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'rolling'
        type: choice
        options:
        - rolling    # æ»šåŠ¨éƒ¨ç½²
        - blue_green # è“ç»¿éƒ¨ç½²

env:
  NODE_VERSION: '20'
  APP_NAME: 'salary-system-v3'
  CONTAINER_PORT: '3000'
  HOST_PORT: '80'

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Run tests
      working-directory: ./frontend
      run: |
        npm run lint
        npx tsc --noEmit
        
    - name: Build application for production
      working-directory: ./frontend
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        NODE_ENV: production
      run: |
        echo "ğŸ—ï¸  å¼€å§‹æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
        npm run build
        
        # æ˜¾ç¤ºæ„å»ºç»“æœä¿¡æ¯
        echo "ğŸ“¦ æ„å»ºå®Œæˆï¼Œæ–‡ä»¶ç»Ÿè®¡:"
        ls -la dist/
        du -sh dist/
        find dist/ -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
          
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: frontend/dist/
        retention-days: 7

  # æ„å»ºå’Œæ¨é€ Docker é•œåƒ
  build-and-push-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    
    # ä½¿ç”¨ github-pages Environment secrets
    environment: 
      name: github-pages
      
    outputs:
      image-tag: ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
      image-digest: ${{ steps.build.outputs.digest }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./frontend/dist
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        build-args: |
          NODE_VERSION=${{ env.NODE_VERSION }}
          
    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      continue-on-error: true
      with:
        image: ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}:latest
        format: spdx-json
        output-file: /tmp/sbom.spdx.json
        
    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      if: success() || failure()
      continue-on-error: true
      with:
        name: sbom
        path: /tmp/sbom.spdx.json

  # éƒ¨ç½²åˆ°ç§æœ‰æœåŠ¡å™¨
  deploy-to-server:
    name: Deploy to Private Server
    runs-on: ubuntu-latest
    needs: build-and-push-image
    
    # ä½¿ç”¨ github-pages Environment secrets
    environment: 
      name: github-pages
      
    steps:
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        
    - name: Validate deployment configuration
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²é…ç½®..."
        
        # æ£€æŸ¥å¿…è¦çš„ Secrets
        if [ -z "${{ secrets.SSH_USER }}" ]; then
          echo "âŒ SSH_USER secret æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.SSH_HOST }}" ]; then
          echo "âŒ SSH_HOST secret æœªé…ç½®"  
          exit 1
        fi
        
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "âŒ DOCKER_USERNAME secret æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
          echo "âŒ DOCKERHUB_TOKEN secret æœªé…ç½®"
          exit 1
        fi
        
        echo "âœ… SSH å’Œ Docker é…ç½®éªŒè¯é€šè¿‡"
        echo "ç”¨æˆ·: ${{ secrets.SSH_USER }}"
        echo "ä¸»æœº: ${{ secrets.SSH_HOST }}"
        echo "é•œåƒ: ${{ needs.build-and-push-image.outputs.image-tag }}"
        
    # å¥åº·æ£€æŸ¥ - éƒ¨ç½²å‰
    - name: Pre-deployment health check
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²å‰å¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
          if ! command -v docker &> /dev/null; then
            echo "âŒ Docker æœªå®‰è£…"
            exit 1
          fi
          echo "âœ… Docker ç‰ˆæœ¬: $(docker --version)"
          
          # æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€
          if ! systemctl is-active --quiet docker; then
            echo "âŒ Docker æœåŠ¡æœªè¿è¡Œ"
            exit 1
          fi
          echo "âœ… Docker æœåŠ¡è¿è¡Œæ­£å¸¸"
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          if [ "$disk_usage" -gt 85 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼š${disk_usage}%"
            exit 1
          fi
          echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨ç‡ï¼š${disk_usage}%"
          
          # æ£€æŸ¥å†…å­˜
          memory_free=$(free | awk '/^Mem:/ {printf "%.1f", (($2-$3)/$2)*100}')
          echo "ğŸ’¾ å¯ç”¨å†…å­˜ï¼š${memory_free}%"
          
          echo "âœ… æœåŠ¡å™¨çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²"
        EOF
        
    # ç™»å½• Docker Hubï¼ˆæœåŠ¡å™¨ç«¯ï¼‰
    - name: Login to Docker Hub on Server
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ” æœåŠ¡å™¨ç™»å½• Docker Hub..."
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        EOF
        
    # å®¹å™¨éƒ¨ç½²
    - name: Deploy container
      env:
        DEPLOY_TYPE: ${{ github.event.inputs.deploy_type || 'rolling' }}
        IMAGE_TAG: ${{ needs.build-and-push-image.outputs.image-tag }}
        CONTAINER_NAME: ${{ env.APP_NAME }}
        HOST_PORT: ${{ env.HOST_PORT }}
        CONTAINER_PORT: ${{ env.CONTAINER_PORT }}
      run: |
        echo "ğŸš€ å¼€å§‹å®¹å™¨éƒ¨ç½²..."
        echo "éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
        echo "é•œåƒæ ‡ç­¾: $IMAGE_TAG"
        echo "å®¹å™¨åç§°: $CONTAINER_NAME"
        echo "ç«¯å£æ˜ å°„: $HOST_PORT:$CONTAINER_PORT"
        
        if [ "$DEPLOY_TYPE" = "blue_green" ]; then
          # è“ç»¿éƒ¨ç½²
          echo "ğŸ’™ğŸ’š ä½¿ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥"
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            set -e
            
            # å®šä¹‰å®¹å™¨åç§°
            BLUE_CONTAINER="${{ env.APP_NAME }}-blue"
            GREEN_CONTAINER="${{ env.APP_NAME }}-green" 
            CURRENT_CONTAINER="${{ env.APP_NAME }}"
            
            # æ£€æŸ¥å½“å‰è¿è¡Œçš„å®¹å™¨
            if docker ps -q -f name=\$CURRENT_CONTAINER | grep -q .; then
              echo "å‘ç°å½“å‰è¿è¡Œçš„å®¹å™¨ï¼Œæ ‡è®°ä¸ºè“è‰²ç¯å¢ƒ"
              docker rename \$CURRENT_CONTAINER \$BLUE_CONTAINER 2>/dev/null || echo "å®¹å™¨å·²é‡å‘½å"
            fi
            
            # å¯åŠ¨ç»¿è‰²ç¯å¢ƒ
            echo "å¯åŠ¨ç»¿è‰²ç¯å¢ƒ: \$GREEN_CONTAINER"
            docker run -d \
              --name \$GREEN_CONTAINER \
              --restart unless-stopped \
              -p ${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }} \
              --health-cmd="curl -f http://localhost:${{ env.CONTAINER_PORT }}/ || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              ${{ needs.build-and-push-image.outputs.image-tag }}
              
            # ç­‰å¾…ç»¿è‰²ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡
            echo "ç­‰å¾…ç»¿è‰²ç¯å¢ƒå¯åŠ¨..."
            for i in {1..30}; do
              if docker ps -q -f name=\$GREEN_CONTAINER -f health=healthy | grep -q .; then
                echo "âœ… ç»¿è‰²ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
                break
              fi
              if [ \$i -eq 30 ]; then
                echo "âŒ ç»¿è‰²ç¯å¢ƒå¥åº·æ£€æŸ¥è¶…æ—¶"
                exit 1
              fi
              sleep 2
            done
            
            # åˆ‡æ¢æµé‡åˆ°ç»¿è‰²ç¯å¢ƒ
            echo "åˆ‡æ¢å®¹å™¨åç§°ï¼Œå¯ç”¨ç»¿è‰²ç¯å¢ƒ"
            docker stop \$BLUE_CONTAINER 2>/dev/null || echo "è“è‰²ç¯å¢ƒå·²åœæ­¢"
            docker rename \$GREEN_CONTAINER \$CURRENT_CONTAINER
            
            # æ¸…ç†è“è‰²ç¯å¢ƒ
            echo "æ¸…ç†è“è‰²ç¯å¢ƒ"
            docker rm \$BLUE_CONTAINER 2>/dev/null || echo "è“è‰²ç¯å¢ƒå·²æ¸…ç†"
            
            echo "âœ… è“ç»¿éƒ¨ç½²å®Œæˆ"
          EOF
          
        else
          # æ»šåŠ¨éƒ¨ç½²
          echo "ğŸ”„ ä½¿ç”¨æ»šåŠ¨éƒ¨ç½²ç­–ç•¥"
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            set -e
            
            CONTAINER_NAME="${{ env.APP_NAME }}"
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            if docker ps -q -f name=\$CONTAINER_NAME | grep -q .; then
              echo "åœæ­¢ç°æœ‰å®¹å™¨: \$CONTAINER_NAME"
              docker stop \$CONTAINER_NAME
              docker rm \$CONTAINER_NAME
            fi
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "å¯åŠ¨æ–°å®¹å™¨: \$CONTAINER_NAME"
            docker run -d \
              --name \$CONTAINER_NAME \
              --restart unless-stopped \
              -p ${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }} \
              --health-cmd="curl -f http://localhost:${{ env.CONTAINER_PORT }}/ || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              -e NODE_ENV=production \
              ${{ needs.build-and-push-image.outputs.image-tag }}
              
            echo "âœ… æ»šåŠ¨éƒ¨ç½²å®Œæˆ"
          EOF
        fi
        
    # éƒ¨ç½²åå¥åº·æ£€æŸ¥
    - name: Post-deployment health check
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²åå¥åº·æ£€æŸ¥..."
          
          CONTAINER_NAME="${{ env.APP_NAME }}"
          
          # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
          if ! docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
            echo "âŒ å®¹å™¨æœªè¿è¡Œ"
            exit 1
          fi
          echo "âœ… å®¹å™¨è¿è¡ŒçŠ¶æ€æ­£å¸¸"
          
          # æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
          for i in {1..30}; do
            HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_NAME 2>/dev/null || echo "none")
            if [ "$HEALTH" = "healthy" ]; then
              echo "âœ… å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            elif [ "$HEALTH" = "unhealthy" ]; then
              echo "âŒ å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
              docker logs $CONTAINER_NAME --tail 50
              exit 1
            fi
            
            if [ $i -eq 30 ]; then
              echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶"
              docker logs $CONTAINER_NAME --tail 50
              exit 1
            fi
            
            echo "ç­‰å¾…å®¹å™¨å¥åº·æ£€æŸ¥... ($i/30)"
            sleep 5
          done
          
          # æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
          echo "ğŸ“Š å®¹å™¨çŠ¶æ€ä¿¡æ¯:"
          docker ps -f name=$CONTAINER_NAME
          echo ""
          echo "ğŸ“‹ å®¹å™¨è¯¦ç»†ä¿¡æ¯:"
          docker inspect $CONTAINER_NAME | jq '.[] | {Name, State, Config: {Image, Env}, NetworkSettings: {Ports}}'
        EOF
        
        # HTTP å¥åº·æ£€æŸ¥
        max_attempts=10
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "å°è¯•ç¬¬ $attempt æ¬¡ HTTP æ£€æŸ¥..."
          
          if curl -f -s -I "http://${{ secrets.SSH_HOST }}:${{ env.HOST_PORT }}" | head -1 | grep -q "200\|301\|302"; then
            echo "âœ… HTTP å¥åº·æ£€æŸ¥é€šè¿‡"
            curl -I "http://${{ secrets.SSH_HOST }}:${{ env.HOST_PORT }}"
            break
          fi
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âš ï¸  HTTP æ£€æŸ¥æœªé€šè¿‡ï¼Œä½†å®¹å™¨æ­£åœ¨è¿è¡Œ"
            if [ -n "${{ secrets.SERVER_DOMAIN }}" ]; then
              echo "è¯·æ‰‹åŠ¨æ£€æŸ¥åº”ç”¨ï¼šhttp://${{ secrets.SERVER_DOMAIN }}"
            else
              echo "è¯·æ‰‹åŠ¨æ£€æŸ¥åº”ç”¨ï¼šhttp://${{ secrets.SSH_HOST }}:${{ env.HOST_PORT }}"
            fi
          fi
          
          sleep 10
          attempt=$((attempt + 1))
        done
        
        echo "ğŸ‰ éƒ¨ç½²å¥åº·æ£€æŸ¥å®Œæˆï¼"
        
    # æ¸…ç†æ—§å®¹å™¨é•œåƒ
    - name: Cleanup old images
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ§¹ æ¸…ç†æ—§å®¹å™¨é•œåƒ..."
          
          # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰
          docker image prune -a -f --filter "until=72h"
          
          # æ˜¾ç¤ºå½“å‰é•œåƒä½¿ç”¨æƒ…å†µ
          echo "ğŸ“Š Docker é•œåƒä½¿ç”¨æƒ…å†µ:"
          docker images | grep salary-system || echo "æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é•œåƒ"
          
          echo "ğŸ’¾ Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          docker system df
        EOF
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸš€ Docker å®¹å™¨éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "é•œåƒ: ${{ needs.build-and-push-image.outputs.image-tag }}"
          echo "ç‰ˆæœ¬: ${{ github.sha }}"
          echo "éƒ¨ç½²ç±»å‹: ${{ github.event.inputs.deploy_type || 'rolling' }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
          echo ""
          if [ -n "${{ secrets.SERVER_DOMAIN }}" ]; then
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_DOMAIN }}"
          else
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SSH_HOST }}:${{ env.HOST_PORT }}"
          fi
          echo ""
          echo "ğŸ” ç›‘æ§å‘½ä»¤ï¼š"
          echo "docker logs ${{ env.APP_NAME }} -f"
          echo "docker stats ${{ env.APP_NAME }}"
        else
          echo "âŒ Docker å®¹å™¨éƒ¨ç½²å¤±è´¥ï¼"
          echo ""
          echo "ğŸ”§ æ•…éšœæ’é™¤å»ºè®®ï¼š"
          echo "1. æ£€æŸ¥ SSH è¿æ¥æ˜¯å¦æ­£å¸¸"
          echo "2. éªŒè¯ Docker æœåŠ¡çŠ¶æ€"
          echo "3. ç¡®è®¤é•œåƒæ˜¯å¦æˆåŠŸæ¨é€"
          echo "4. æ£€æŸ¥ç«¯å£ ${{ env.HOST_PORT }} æ˜¯å¦è¢«å ç”¨"
          echo "5. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼šdocker logs ${{ env.APP_NAME }}"
          echo "6. æ£€æŸ¥æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ"
        fi