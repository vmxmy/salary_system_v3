name: Build and Package Artifacts

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-package:
    name: Build Frontend and Create Download Package
    runs-on: ubuntu-latest
    
    # Use github-pages environment for secrets access
    environment: 
      name: github-pages
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      working-directory: ./frontend
      run: |
        echo "ðŸ”„ å®‰è£…é¡¹ç›®ä¾èµ–..."
        npm ci --prefer-offline --no-audit
        
    - name: Build frontend application
      working-directory: ./frontend
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        VITE_BASE_PATH: '/'
        NODE_ENV: production
      run: |
        echo "ðŸ—ï¸  å¼€å§‹æž„å»ºç”Ÿäº§ç‰ˆæœ¬..."
        npm run build
        
        # æ˜¾ç¤ºæž„å»ºç»“æžœç»Ÿè®¡
        echo "ðŸ“¦ æž„å»ºå®Œæˆï¼Œæ–‡ä»¶ç»Ÿè®¡:"
        ls -la dist/
        du -sh dist/
        echo ""
        echo "ðŸ“Š ä¸»è¦æ–‡ä»¶å¤§å°:"
        find dist/ -name "*.js" -o -name "*.css" -o -name "*.html" | head -10 | xargs ls -lh
        
    - name: Prepare build information
      id: build-info
      run: |
        # ç”Ÿæˆæž„å»ºä¿¡æ¯
        echo "BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "BUILD_DATE=$(date -u '+%Y%m%d')" >> $GITHUB_OUTPUT
        echo "BUILD_TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        echo "COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT
        
        # è®¡ç®—æ–‡ä»¶ç»Ÿè®¡
        cd frontend/dist
        TOTAL_SIZE=$(du -sb . | cut -f1)
        FILE_COUNT=$(find . -type f | wc -l)
        echo "TOTAL_SIZE_BYTES=$TOTAL_SIZE" >> $GITHUB_OUTPUT
        echo "TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))" >> $GITHUB_OUTPUT
        echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_OUTPUT
        
    - name: Create build information file
      working-directory: ./frontend/dist
      run: |
        # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
        cat > BUILD_INFO.txt << 'BUILD_INFO_EOF'
        # è–ªèµ„ç®¡ç†ç³»ç»Ÿ V3 - æž„å»ºä¿¡æ¯
        
        ## æž„å»ºè¯¦æƒ…
        - æž„å»ºæ—¶é—´: ${{ steps.build-info.outputs.BUILD_TIME }}
        - æäº¤ç‰ˆæœ¬: ${{ github.sha }}
        - æäº¤çŸ­ç : ${{ steps.build-info.outputs.COMMIT_SHORT }}
        - åˆ†æ”¯: ${{ github.ref_name }}
        - æž„å»ºè€…: ${{ github.actor }}
        
        ## æž„å»ºç»Ÿè®¡
        - æ€»æ–‡ä»¶æ•°: ${{ steps.build-info.outputs.FILE_COUNT }} ä¸ªæ–‡ä»¶
        - æ€»å¤§å°: ${{ steps.build-info.outputs.TOTAL_SIZE_MB }} MB
        - åŽ‹ç¼©åŽä¼°è®¡: ~${{ steps.build-info.outputs.TOTAL_SIZE_MB }}/3 MB (gzip)
        
        ## éƒ¨ç½²è¯´æ˜Ž
        å°†æ­¤æž„å»ºåŒ…è§£åŽ‹åˆ° Web æœåŠ¡å™¨æ ¹ç›®å½•å³å¯éƒ¨ç½²ã€‚
        
        ## çŽ¯å¢ƒé…ç½®
        - Node.js: ${{ env.NODE_VERSION }}
        - Vite: 7.x
        - React: 19.x
        - æž„å»ºç›®æ ‡: ES2020
        
        ## å¿«é€Ÿéƒ¨ç½²å‘½ä»¤
        ```bash
        # è§£åŽ‹æž„å»ºåŒ…
        unzip salary-system-v3-build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}.zip
        
        # ä½¿ç”¨ Docker éƒ¨ç½²
        docker run -d --name salary-system-v3 \\
          --restart unless-stopped \\
          -p 3001:80 \\
          -v $(pwd)/dist:/usr/share/nginx/html:ro \\
          nginx:alpine
        
        # ä½¿ç”¨ Python ç®€å•æœåŠ¡å™¨æµ‹è¯•
        cd dist
        python3 -m http.server 8080
        ```
        
        ## è®¿é—®åœ°å€
        éƒ¨ç½²å®ŒæˆåŽè®¿é—®: http://localhost:3001
        
        ---
        è‡ªåŠ¨ç”ŸæˆäºŽ: ${{ steps.build-info.outputs.BUILD_TIME }}
        BUILD_INFO_EOF
        
    - name: Create deployment package
      working-directory: ./frontend
      run: |
        echo "ðŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…..."
        
        # åˆ›å»ºåŒ…ç›®å½•ç»“æž„
        mkdir -p package/salary-system-v3
        
        # å¤åˆ¶æž„å»ºæ–‡ä»¶
        cp -r dist/* package/salary-system-v3/
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > package/deploy.sh << 'DEPLOY_SCRIPT_EOF'
        #!/bin/bash
        # è–ªèµ„ç®¡ç†ç³»ç»Ÿ V3 - å¿«é€Ÿéƒ¨ç½²è„šæœ¬
        
        set -e
        
        APP_NAME="salary-system-v3"
        PORT=${1:-3001}
        BUILD_DIR="salary-system-v3"
        
        echo "ðŸš€ å¼€å§‹éƒ¨ç½²è–ªèµ„ç®¡ç†ç³»ç»Ÿ V3..."
        echo "ç«¯å£: $PORT"
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æž„å»ºç›®å½•
        if [ ! -d "$BUILD_DIR" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°æž„å»ºç›®å½• $BUILD_DIR"
            echo "è¯·ç¡®ä¿åœ¨è§£åŽ‹åŽçš„ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬"
            exit 1
        fi
        
        # åœæ­¢çŽ°æœ‰å®¹å™¨
        echo "ðŸ›‘ åœæ­¢çŽ°æœ‰å®¹å™¨..."
        docker stop $APP_NAME 2>/dev/null || echo "å®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡åœæ­¢"
        docker rm $APP_NAME 2>/dev/null || echo "å®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤"
        
        # å¯åŠ¨æ–°å®¹å™¨
        echo "ðŸ³ å¯åŠ¨ Docker å®¹å™¨..."
        docker run -d \
          --name $APP_NAME \
          --restart unless-stopped \
          -p $PORT:80 \
          -v $(pwd)/$BUILD_DIR:/usr/share/nginx/html:ro \
          --health-cmd="curl -f http://localhost/ || exit 1" \
          --health-interval=30s \
          --health-timeout=10s \
          --health-retries=3 \
          nginx:alpine
        
        echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
        sleep 5
        
        # å¥åº·æ£€æŸ¥
        if curl -f -s http://localhost:$PORT > /dev/null; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo ""
            echo "ðŸŒ è®¿é—®åœ°å€: http://localhost:$PORT"
            echo "ðŸ” æŸ¥çœ‹æ—¥å¿—: docker logs $APP_NAME -f"
            echo "ðŸ“ˆ æŸ¥çœ‹çŠ¶æ€: docker stats $APP_NAME"
        else
            echo "âš ï¸  å®¹å™¨å·²å¯åŠ¨ï¼Œä½†å¥åº·æ£€æŸ¥å¤±è´¥"
            echo "è¯·æ£€æŸ¥: docker logs $APP_NAME"
        fi
        DEPLOY_SCRIPT_EOF
        
        chmod +x package/deploy.sh
        
        # åˆ›å»º README æ–‡ä»¶
        cat > package/README.md << 'README_EOF'
        # è–ªèµ„ç®¡ç†ç³»ç»Ÿ V3 - æž„å»ºåŒ…
        
        ## åŒ…å«å†…å®¹
        
        - `salary-system-v3/` - å®Œæ•´çš„å‰ç«¯æž„å»ºæ–‡ä»¶
        - `deploy.sh` - å¿«é€Ÿéƒ¨ç½²è„šæœ¬
        - `README.md` - æ­¤æ–‡ä»¶
        
        ## å¿«é€Ÿéƒ¨ç½²
        
        ### æ–¹æ³• 1: ä½¿ç”¨éƒ¨ç½²è„šæœ¬ (æŽ¨è)
        ```bash
        # è§£åŽ‹æž„å»ºåŒ…åŽè¿è¡Œ
        ./deploy.sh [ç«¯å£å·]
        
        # ç¤ºä¾‹: åœ¨ç«¯å£ 3001 éƒ¨ç½²
        ./deploy.sh 3001
        ```
        
        ### æ–¹æ³• 2: æ‰‹åŠ¨ Docker éƒ¨ç½²
        ```bash
        docker run -d --name salary-system-v3 \
          --restart unless-stopped \
          -p 3001:80 \
          -v $(pwd)/salary-system-v3:/usr/share/nginx/html:ro \
          nginx:alpine
        ```
        
        ### æ–¹æ³• 3: ç›´æŽ¥ Web æœåŠ¡å™¨éƒ¨ç½²
        å°† `salary-system-v3/` ç›®å½•å†…å®¹å¤åˆ¶åˆ° Web æœåŠ¡å™¨æ ¹ç›®å½•ã€‚
        
        ## ç³»ç»Ÿè¦æ±‚
        
        - Docker (æŽ¨è)
        - æˆ–ä»»ä½•æ”¯æŒé™æ€æ–‡ä»¶çš„ Web æœåŠ¡å™¨ (Nginx, Apache ç­‰)
        
        ## è®¿é—®åœ°å€
        
        éƒ¨ç½²å®ŒæˆåŽè®¿é—®: http://localhost:3001 (æˆ–æ‚¨è®¾ç½®çš„ç«¯å£)
        
        ## æ•…éšœæŽ’é™¤
        
        1. **ç«¯å£è¢«å ç”¨**: ä¿®æ”¹éƒ¨ç½²è„šæœ¬ä¸­çš„ç«¯å£å·
        2. **Docker æœªå®‰è£…**: è¯·å®‰è£… Docker æˆ–ä½¿ç”¨å…¶ä»– Web æœåŠ¡å™¨
        3. **æƒé™é—®é¢˜**: ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™ `chmod +x deploy.sh`
        
        ---
        æž„å»ºæ—¶é—´: ${{ steps.build-info.outputs.BUILD_TIME }}
        æž„å»ºç‰ˆæœ¬: ${{ steps.build-info.outputs.COMMIT_SHORT }}
        README_EOF
        
        # æ‰“åŒ…æˆ ZIP æ–‡ä»¶
        PACKAGE_NAME="salary-system-v3-build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}"
        cd package
        zip -r "$PACKAGE_NAME.zip" . -x "*.DS_Store*" "*.git*"
        
        echo "âœ… æž„å»ºåŒ…åˆ›å»ºå®Œæˆ: $PACKAGE_NAME.zip"
        ls -lh "$PACKAGE_NAME.zip"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: salary-system-v3-build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}
        path: frontend/package/salary-system-v3-build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}.zip
        retention-days: 30
        compression-level: 6
        
    - name: Upload individual build files (backup)
      uses: actions/upload-artifact@v4
      with:
        name: build-files-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}
        path: frontend/dist/
        retention-days: 7
        
    - name: Create GitHub Release (on main branch)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}
        name: "æž„å»ºç‰ˆæœ¬ ${{ steps.build-info.outputs.BUILD_DATE }} (${{ steps.build-info.outputs.COMMIT_SHORT }})"
        body: |
          ## ðŸš€ è–ªèµ„ç®¡ç†ç³»ç»Ÿ V3 - è‡ªåŠ¨æž„å»ºåŒ…

          ### ðŸ“‹ æž„å»ºä¿¡æ¯
          - **æž„å»ºæ—¶é—´**: ${{ steps.build-info.outputs.BUILD_TIME }}
          - **æäº¤ç‰ˆæœ¬**: `${{ github.sha }}`
          - **æäº¤çŸ­ç **: `${{ steps.build-info.outputs.COMMIT_SHORT }}`
          - **åˆ†æ”¯**: `${{ github.ref_name }}`
          - **æ€»æ–‡ä»¶æ•°**: ${{ steps.build-info.outputs.FILE_COUNT }} ä¸ª
          - **æ€»å¤§å°**: ${{ steps.build-info.outputs.TOTAL_SIZE_MB }} MB

          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          1. ä¸‹è½½ä¸‹æ–¹çš„æž„å»ºåŒ… ZIP æ–‡ä»¶
          2. è§£åŽ‹åˆ°æœåŠ¡å™¨ç›®å½•
          3. è¿è¡Œ `./deploy.sh` å¿«é€Ÿéƒ¨ç½²
          4. è®¿é—® http://localhost:3001

          ### ðŸ› ï¸ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤
          ```bash
          # ä¸‹è½½å¹¶è§£åŽ‹
          wget https://github.com/${{ github.repository }}/releases/download/build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}/salary-system-v3-build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}.zip
          unzip salary-system-v3-build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}.zip
          
          # ä½¿ç”¨éƒ¨ç½²è„šæœ¬
          ./deploy.sh 3001
          ```

          ### ðŸ“ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹æœ€è¿‘çš„ commit è®°å½•äº†è§£æœ¬æ¬¡æž„å»ºåŒ…å«çš„æ›´æ–°å†…å®¹ã€‚

          ---
          ðŸ¤– è‡ªåŠ¨ç”ŸæˆäºŽ GitHub Actions
        files: |
          frontend/package/salary-system-v3-build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}.zip
        draft: false
        prerelease: false
        generate_release_notes: false
        
    - name: Build completion summary
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ðŸŽ‰ æž„å»ºåŒ…ç”ŸæˆæˆåŠŸï¼"
          echo ""
          echo "ðŸ“Š æž„å»ºç»Ÿè®¡:"
          echo "- æž„å»ºæ—¶é—´: ${{ steps.build-info.outputs.BUILD_TIME }}"
          echo "- æ–‡ä»¶æ•°é‡: ${{ steps.build-info.outputs.FILE_COUNT }} ä¸ª"
          echo "- åŒ…å¤§å°: ${{ steps.build-info.outputs.TOTAL_SIZE_MB }} MB"
          echo "- æäº¤ç‰ˆæœ¬: ${{ steps.build-info.outputs.COMMIT_SHORT }}"
          echo ""
          echo "ðŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "1. GitHub Actions Artifacts (30å¤©ä¿å­˜æœŸ)"
          echo "2. GitHub Release (æ°¸ä¹…ä¿å­˜)"
          echo ""
          echo "ðŸ”— ä¸‹è½½é“¾æŽ¥:"
          echo "- Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- Release: https://github.com/${{ github.repository }}/releases/tag/build-${{ steps.build-info.outputs.BUILD_TIMESTAMP }}"
          echo ""
          echo "ðŸš€ å¿«é€Ÿéƒ¨ç½²:"
          echo "ä¸‹è½½ZIPæ–‡ä»¶ï¼Œè§£åŽ‹åŽè¿è¡Œ ./deploy.sh"
        else
          echo "âŒ æž„å»ºåŒ…ç”Ÿæˆå¤±è´¥ï¼"
          echo ""
          echo "ðŸ”§ æ•…éšœæŽ’é™¤å»ºè®®:"
          echo "1. æ£€æŸ¥å‰ç«¯ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…"
          echo "2. éªŒè¯çŽ¯å¢ƒå˜é‡é…ç½®"
          echo "3. ç¡®è®¤æž„å»ºè„šæœ¬æ— è¯¯"
          echo "4. æŸ¥çœ‹è¯¦ç»†æž„å»ºæ—¥å¿—"
        fi