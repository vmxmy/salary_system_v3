name: ğŸš€ Deploy Supabase Edge Functions

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/functions/**'
      - '.github/workflows/deploy-edge-functions.yml'
  pull_request:
    branches: [main]
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:
    inputs:
      function_name:
        description: 'Specific function to deploy (optional, leave empty for all changed functions)'
        required: false
        type: string
      force_deploy:
        description: 'Force deploy even if no changes detected'
        required: false
        type: boolean
        default: false

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

jobs:
  # ============================================
  # æ£€æµ‹å˜æ›´çš„ Edge Functions
  # ============================================
  detect-changes:
    name: ğŸ” Detect Function Changes
    runs-on: ubuntu-latest
    outputs:
      functions-changed: ${{ steps.changes.outputs.functions-changed }}
      changed-functions: ${{ steps.changes.outputs.changed-functions }}
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detect Changed Functions
        id: changes
        run: |
          echo "ğŸ” Detecting changes in Edge Functions..."
          
          # æ‰‹åŠ¨è§¦å‘æ—¶çš„å¤„ç†
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.function_name }}" != "" ]]; then
              echo "Manual deployment requested for function: ${{ github.event.inputs.function_name }}"
              echo "functions-changed=true" >> $GITHUB_OUTPUT
              echo "changed-functions=${{ github.event.inputs.function_name }}" >> $GITHUB_OUTPUT
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              exit 0
            elif [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
              echo "Force deployment requested for all functions"
              all_functions=$(find supabase/functions -maxdepth 1 -type d -not -path "supabase/functions" | xargs basename -a | tr '\n' ',' | sed 's/,$//')
              echo "functions-changed=true" >> $GITHUB_OUTPUT
              echo "changed-functions=$all_functions" >> $GITHUB_OUTPUT
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # æ£€æµ‹æœ€è¿‘æäº¤ä¸­çš„å˜æ›´
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          echo "Comparing changes between $BASE_SHA and $HEAD_SHA"
          
          # è·å–å˜æ›´çš„å‡½æ•°åˆ—è¡¨
          changed_files=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep '^supabase/functions/' || true)
          
          if [[ -z "$changed_files" ]]; then
            echo "No Edge Function changes detected"
            echo "functions-changed=false" >> $GITHUB_OUTPUT
            echo "changed-functions=" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æå–å˜æ›´çš„å‡½æ•°åç§°
          changed_functions=$(echo "$changed_files" | cut -d'/' -f3 | sort | uniq | tr '\n' ',' | sed 's/,$//')
          
          echo "Changed functions detected: $changed_functions"
          echo "Changed files: $changed_files"
          
          echo "functions-changed=true" >> $GITHUB_OUTPUT
          echo "changed-functions=$changed_functions" >> $GITHUB_OUTPUT
          echo "should-deploy=true" >> $GITHUB_OUTPUT

  # ============================================
  # éªŒè¯ Edge Functions ä»£ç 
  # ============================================
  validate-functions:
    name: âœ… Validate Functions
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-deploy == 'true'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: âœ… Validate TypeScript/JavaScript
        run: |
          echo "ğŸ” Validating Edge Functions syntax..."
          
          functions="${{ needs.detect-changes.outputs.changed-functions }}"
          IFS=',' read -ra FUNCTION_ARRAY <<< "$functions"
          
          for function_name in "${FUNCTION_ARRAY[@]}"; do
            function_path="supabase/functions/$function_name"
            
            if [[ -d "$function_path" ]]; then
              echo "ğŸ“ Validating function: $function_name"
              
              # æ£€æŸ¥ä¸»å…¥å£æ–‡ä»¶
              if [[ -f "$function_path/index.ts" ]]; then
                echo "  âœ“ TypeScript validation for $function_name/index.ts"
                deno check "$function_path/index.ts"
              elif [[ -f "$function_path/index.js" ]]; then
                echo "  âœ“ JavaScript validation for $function_name/index.js"
                deno check "$function_path/index.js"
              else
                echo "  âŒ No index.ts or index.js found in $function_path"
                exit 1
              fi
              
              # éªŒè¯ deno.json é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              if [[ -f "$function_path/deno.json" ]]; then
                echo "  âœ“ Validating deno.json configuration"
                cat "$function_path/deno.json" | jq empty
              fi
              
              echo "  âœ… Function $function_name validated successfully"
            else
              echo "  âŒ Function directory $function_path does not exist"
              exit 1
            fi
          done

      - name: ğŸ§ª Run Function Tests (if available)
        run: |
          echo "ğŸ§ª Running Edge Function tests..."
          
          functions="${{ needs.detect-changes.outputs.changed-functions }}"
          IFS=',' read -ra FUNCTION_ARRAY <<< "$functions"
          
          for function_name in "${FUNCTION_ARRAY[@]}"; do
            test_file="supabase/functions/$function_name/test.ts"
            if [[ -f "$test_file" ]]; then
              echo "  ğŸ§ª Running tests for $function_name"
              cd "supabase/functions/$function_name"
              deno test --allow-all
              cd ../../..
            else
              echo "  â„¹ï¸  No test file found for $function_name (optional)"
            fi
          done

  # ============================================
  # éƒ¨ç½²åˆ° Supabase
  # ============================================
  deploy:
    name: ğŸš€ Deploy to Supabase
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-functions]
    if: needs.detect-changes.outputs.should-deploy == 'true'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: ${{ steps.deploy.outputs.function-url }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ” Authenticate Supabase
        run: |
          echo "ğŸ” Authenticating with Supabase..."
          echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token
          
          # éªŒè¯è®¤è¯çŠ¶æ€
          if ! supabase projects list >/dev/null 2>&1; then
            echo "âŒ Supabase authentication failed"
            exit 1
          fi
          
          echo "âœ… Supabase authentication successful"

      - name: ğŸ”— Link Supabase Project
        run: |
          echo "ğŸ”— Linking to Supabase project..."
          supabase link --project-ref $SUPABASE_PROJECT_ID
          echo "âœ… Project linked successfully"

      - name: ğŸ“¤ Deploy Edge Functions
        id: deploy
        run: |
          echo "ğŸš€ Deploying Edge Functions to Supabase..."
          
          functions="${{ needs.detect-changes.outputs.changed-functions }}"
          IFS=',' read -ra FUNCTION_ARRAY <<< "$functions"
          
          deployed_functions=()
          function_urls=()
          
          for function_name in "${FUNCTION_ARRAY[@]}"; do
            echo "ğŸ“¤ Deploying function: $function_name"
            
            # éƒ¨ç½²å•ä¸ªå‡½æ•°
            if supabase functions deploy "$function_name" --project-ref $SUPABASE_PROJECT_ID; then
              echo "âœ… Function $function_name deployed successfully"
              deployed_functions+=("$function_name")
              
              # æ„å»ºå‡½æ•°URLï¼ˆå‡è®¾æ ‡å‡†Supabase URLç»“æ„ï¼‰
              project_url="https://$SUPABASE_PROJECT_ID.supabase.co"
              function_url="$project_url/functions/v1/$function_name"
              function_urls+=("$function_name: $function_url")
            else
              echo "âŒ Failed to deploy function: $function_name"
              exit 1
            fi
          done
          
          # è¾“å‡ºéƒ¨ç½²ç»“æœ
          echo "deployed-functions=${deployed_functions[*]}" >> $GITHUB_OUTPUT
          printf "function-urls:\n%s\n" "${function_urls[@]}" >> $GITHUB_OUTPUT
          
          # è®¾ç½®ç¬¬ä¸€ä¸ªå‡½æ•°çš„URLä½œä¸ºç¯å¢ƒURL
          if [[ ${#function_urls[@]} -gt 0 ]]; then
            first_url=$(echo "${function_urls[0]}" | cut -d' ' -f2)
            echo "function-url=$first_url" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Test Deployed Functions
        run: |
          echo "ğŸ§ª Testing deployed Edge Functions..."
          
          functions="${{ needs.detect-changes.outputs.changed-functions }}"
          IFS=',' read -ra FUNCTION_ARRAY <<< "$functions"
          
          for function_name in "${FUNCTION_ARRAY[@]}"; do
            echo "ğŸ§ª Testing function: $function_name"
            function_url="https://$SUPABASE_PROJECT_ID.supabase.co/functions/v1/$function_name"
            
            # åŸºæœ¬å¥åº·æ£€æŸ¥ - OPTIONS è¯·æ±‚ (CORS preflight)
            if curl -f -X OPTIONS "$function_url" \
                -H "Origin: https://example.com" \
                -H "Access-Control-Request-Method: POST" \
                --max-time 10 --silent; then
              echo "  âœ… Function $function_name is responding to CORS preflight"
            else
              echo "  âš ï¸  Function $function_name CORS preflight failed (may be expected)"
            fi
            
            # å¦‚æœæ˜¯ ai-agent å‡½æ•°ï¼Œè¿›è¡Œç‰¹æ®Šæµ‹è¯•
            if [[ "$function_name" == "ai-agent" ]]; then
              echo "  ğŸ¤– Testing AI Agent function..."
              # è¿™é‡Œå¯ä»¥æ·»åŠ ç‰¹å®šçš„AI Agentæµ‹è¯•é€»è¾‘
              echo "  â„¹ï¸  AI Agent function deployment verified"
            fi
          done

  # ============================================
  # æ¸…ç†å’Œé€šçŸ¥
  # ============================================
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy]
    if: always() && needs.detect-changes.outputs.should-deploy == 'true'
    steps:
      - name: ğŸ“Š Create Deployment Summary
        run: |
          echo "## ğŸš€ Edge Functions Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "The following functions were deployed:" >> $GITHUB_STEP_SUMMARY
            functions="${{ needs.detect-changes.outputs.changed-functions }}"
            IFS=',' read -ra FUNCTION_ARRAY <<< "$functions"
            for function_name in "${FUNCTION_ARRAY[@]}"; do
              echo "- ğŸŸ¢ **$function_name**" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ All Edge Functions have been successfully deployed to Supabase!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "Some functions failed to deploy. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const deployResult = '${{ needs.deploy.result }}';
            const functions = '${{ needs.detect-changes.outputs.changed-functions }}';
            
            let comment = '## ğŸš€ Edge Functions Deployment Report\n\n';
            
            if (deployResult === 'success') {
              comment += 'âœ… **Deployment Successful**\n\n';
              comment += `The following Edge Functions were successfully deployed:\n`;
              
              functions.split(',').forEach(func => {
                comment += `- ğŸŸ¢ \`${func}\`\n`;
              });
              
              comment += '\nğŸ‰ All functions are ready for testing!';
            } else {
              comment += 'âŒ **Deployment Failed**\n\n';
              comment += 'Please check the workflow logs for detailed error information.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# ============================================
# å·¥ä½œæµé…ç½®è¯´æ˜
# ============================================
# 
# æ­¤å·¥ä½œæµå®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š
# 1. ğŸ” æ™ºèƒ½æ£€æµ‹ Edge Functions å˜æ›´
# 2. âœ… TypeScript/JavaScript è¯­æ³•éªŒè¯
# 3. ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨æµ‹è¯•æ–‡ä»¶ï¼‰
# 4. ğŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ° Supabase
# 5. ğŸ§ª éƒ¨ç½²åå¥åº·æ£€æŸ¥
# 6. ğŸ“¢ ç»“æœé€šçŸ¥å’ŒæŠ¥å‘Š
#
# ç¯å¢ƒå˜é‡è¦æ±‚ï¼š
# - SUPABASE_ACCESS_TOKEN: Supabase è®¿é—®ä»¤ç‰Œ
# - SUPABASE_PROJECT_ID: Supabase é¡¹ç›®ID
# - SUPABASE_DB_PASSWORD: æ•°æ®åº“å¯†ç ï¼ˆå¯é€‰ï¼‰
#
# æ‰‹åŠ¨è§¦å‘å‚æ•°ï¼š
# - function_name: æŒ‡å®šéƒ¨ç½²çš„å‡½æ•°åï¼ˆå¯é€‰ï¼‰
# - force_deploy: å¼ºåˆ¶éƒ¨ç½²æ‰€æœ‰å‡½æ•°ï¼ˆå¿½ç•¥å˜æ›´æ£€æµ‹ï¼‰