name: CORRECT Docker Login Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: false
        default: 'both'
        type: choice
        options:
        - legacy    # ä½¿ç”¨ DOCKER_USERNAME + DOCKER_PASSWORD
        - recommended  # ä½¿ç”¨ DOCKERHUB_USERNAME + DOCKERHUB_TOKEN  
        - both      # ä¸¤ç§éƒ½æµ‹è¯•

jobs:
  correct-docker-test:
    name: æ­£ç¡®çš„ Docker Hub ç™»å½•æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: æ˜¾ç¤ºæ­£ç¡®çš„é…ç½®æ ¼å¼
      run: |
        echo "ğŸ“‹ docker/login-action@v3 çš„æ­£ç¡®ç”¨æ³•:"
        echo ""
        echo "âœ… æ­£ç¡®æ ¼å¼:"
        echo "uses: docker/login-action@v3"
        echo "with:"
        echo "  username: \${{ secrets.DOCKER_USERNAME }}"
        echo "  password: \${{ secrets.DOCKER_PASSWORD }}"
        echo ""
        echo "âŒ é”™è¯¯æ ¼å¼ï¼ˆä½ é‡åˆ°çš„é—®é¢˜ï¼‰:"
        echo "uses: docker/login-action@v3"
        echo "with:"
        echo "  ecr: auto      # âŒ è¿™ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼"
        echo "  logout: true   # âŒ è¿™ä¸æ˜¯æœ‰æ•ˆå‚æ•°ï¼"
        echo ""
        
    # æµ‹è¯•ä¼ ç»Ÿé…ç½®
    - name: æµ‹è¯•ä¼ ç»Ÿé…ç½® (DOCKER_USERNAME + DOCKER_PASSWORD)
      if: github.event.inputs.test_type == 'legacy' || github.event.inputs.test_type == 'both'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      continue-on-error: true
      id: legacy-login
        
    # æµ‹è¯•æ¨èé…ç½®  
    - name: æµ‹è¯•æ¨èé…ç½® (DOCKERHUB_USERNAME + DOCKERHUB_TOKEN)
      if: github.event.inputs.test_type == 'recommended' || github.event.inputs.test_type == 'both'
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      continue-on-error: true
      id: recommended-login
        
    - name: éªŒè¯ç™»å½•ç»“æœ
      run: |
        echo "ğŸ”§ é…ç½®æ£€æŸ¥ç»“æœ:"
        
        # æ£€æŸ¥ secrets å’Œ variables æ˜¯å¦å­˜åœ¨
        if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "âœ… DOCKER_USERNAME secret å·²è®¾ç½®"
        else
          echo "âŒ DOCKER_USERNAME secret æœªè®¾ç½®"
        fi
        
        if [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "âœ… DOCKER_PASSWORD secret å·²è®¾ç½®" 
        else
          echo "âŒ DOCKER_PASSWORD secret æœªè®¾ç½®"
        fi
        
        if [ -n "${{ vars.DOCKERHUB_USERNAME }}" ]; then
          echo "âœ… DOCKERHUB_USERNAME variable å·²è®¾ç½®"
        else
          echo "âŒ DOCKERHUB_USERNAME variable æœªè®¾ç½®"
        fi
        
        if [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
          echo "âœ… DOCKERHUB_TOKEN secret å·²è®¾ç½®"
        else
          echo "âŒ DOCKERHUB_TOKEN secret æœªè®¾ç½®"
        fi
        
        echo ""
        echo "ğŸ“Š ç™»å½•æµ‹è¯•ç»“æœ:"
        
        if [ "${{ steps.legacy-login.outcome }}" = "success" ]; then
          echo "âœ… ä¼ ç»Ÿé…ç½®ç™»å½•æˆåŠŸ"
        elif [ "${{ steps.legacy-login.outcome }}" = "failure" ]; then
          echo "âŒ ä¼ ç»Ÿé…ç½®ç™»å½•å¤±è´¥"
        fi
        
        if [ "${{ steps.recommended-login.outcome }}" = "success" ]; then
          echo "âœ… æ¨èé…ç½®ç™»å½•æˆåŠŸ"  
        elif [ "${{ steps.recommended-login.outcome }}" = "failure" ]; then
          echo "âŒ æ¨èé…ç½®ç™»å½•å¤±è´¥"
        fi
        
    - name: ç®€å•æµ‹è¯• Docker æ“ä½œ
      if: steps.legacy-login.outcome == 'success' || steps.recommended-login.outcome == 'success'
      run: |
        echo "ğŸ§ª æµ‹è¯• Docker åŸºæœ¬æ“ä½œ..."
        docker --version
        docker info | grep "Registry:"
        echo "âœ… Docker ç™»å½•éªŒè¯æˆåŠŸ!"