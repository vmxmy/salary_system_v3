name: Deploy to Private Server

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'rolling'
        type: choice
        options:
        - rolling    # æ»šåŠ¨éƒ¨ç½²
        - blue_green # è“ç»¿éƒ¨ç½²
        - canary     # é‡‘ä¸é›€éƒ¨ç½²

env:
  NODE_VERSION: '20'
  APP_NAME: 'salary-system-v3'

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Run tests
      working-directory: ./frontend
      run: |
        npm run lint
        npx tsc --noEmit
        
    - name: Build application
      working-directory: ./frontend
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        NODE_ENV: production
      run: npm run build
      
    # Docker é•œåƒæ„å»º
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/${{ env.APP_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NODE_VERSION=${{ env.NODE_VERSION }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          GIT_COMMIT=${{ github.sha }}
          
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: frontend/dist/
        retention-days: 7
          
  # éƒ¨ç½²åˆ°ç§æœ‰æœåŠ¡å™¨ (éœ€è¦é…ç½®æœåŠ¡å™¨SSHå‡­æ®)
  deploy-to-server:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: build-and-test
    if: false  # æš‚æ—¶ç¦ç”¨ï¼Œéœ€è¦é…ç½®SSHå‡­æ®ï¼šSSH_PRIVATE_KEY, SSH_USER, SSH_HOST, SSH_KNOWN_HOSTS
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      
    steps:
    - name: Checkout deployment scripts
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          .github/scripts/
          docker-compose.prod.yml
          nginx.conf
          
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        
    # å¥åº·æ£€æŸ¥ - éƒ¨ç½²å‰
    - name: Pre-deployment health check
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²å‰å¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          if [ "$disk_usage" -gt 80 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼š${disk_usage}%"
            exit 1
          fi
          
          # æ£€æŸ¥å†…å­˜
          memory_free=$(free | awk '/^Mem:/ {printf "%.1f", (($2-$3)/$2)*100}')
          echo "ğŸ’¾ å¯ç”¨å†…å­˜ï¼š${memory_free}%"
          
          # æ£€æŸ¥ Docker æœåŠ¡
          if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker æœåŠ¡æœªè¿è¡Œ"
            exit 1
          fi
          
          echo "âœ… æœåŠ¡å™¨çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²"
        EOF
        
    # åˆ›å»ºéƒ¨ç½²ç›®å½•å’Œé…ç½®
    - name: Prepare deployment directory
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          # åˆ›å»ºéƒ¨ç½²ç›®å½•ç»“æ„
          sudo mkdir -p /opt/salary-system/{releases,shared,scripts}
          sudo chown -R $USER:$USER /opt/salary-system
          
          # åˆ›å»ºæ–°ç‰ˆæœ¬ç›®å½•
          RELEASE_DIR="/opt/salary-system/releases/$(date +%Y%m%d_%H%M%S)"
          mkdir -p $RELEASE_DIR
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV
          echo "ğŸ“ åˆ›å»ºå‘å¸ƒç›®å½•ï¼š$RELEASE_DIR"
        EOF
        
    # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬
    - name: Copy deployment files
      run: |
        # å¤åˆ¶ docker-compose é…ç½®
        scp docker-compose.prod.yml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/salary-system/shared/
        scp nginx.conf ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/salary-system/shared/
        
        # å¤åˆ¶éƒ¨ç½²è„šæœ¬
        scp -r .github/scripts/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/salary-system/scripts/
        
    # æ‰§è¡Œéƒ¨ç½²
    - name: Deploy application
      env:
        IMAGE_TAG: ${{ needs.build-and-test.outputs.image-tag }}
        DEPLOY_TYPE: ${{ github.event.inputs.deploy_type || 'rolling' }}
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          cd /opt/salary-system
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export IMAGE_TAG="$IMAGE_TAG"
          export DEPLOY_TYPE="$DEPLOY_TYPE"
          export SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          export SUPABASE_ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}"
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh
        EOF
        
    # éƒ¨ç½²åå¥åº·æ£€æŸ¥
    - name: Post-deployment health check
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²åå¥åº·æ£€æŸ¥..."
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
          max_attempts=30
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "å°è¯•ç¬¬ $attempt æ¬¡å¥åº·æ£€æŸ¥..."
            
            # æ£€æŸ¥åº”ç”¨å“åº”
            if curl -f -s http://localhost:80/health > /dev/null; then
              echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
              break
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè§¦å‘å›æ»š"
              ./scripts/rollback.sh
              exit 1
            fi
            
            sleep 10
            attempt=$((attempt + 1))
          done
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆå¹¶éªŒè¯æˆåŠŸï¼"
        EOF
        
    # æ¸…ç†æ—§ç‰ˆæœ¬
    - name: Cleanup old releases
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /opt/salary-system/releases
          
          # ä¿ç•™æœ€è¿‘ 5 ä¸ªç‰ˆæœ¬ï¼Œåˆ é™¤å…¶ä»–çš„
          ls -t | tail -n +6 | xargs rm -rf
          
          echo "ğŸ§¹ æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€è¿‘ 5 ä¸ªç‰ˆæœ¬"
        EOF
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          echo "ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"
          echo "ç‰ˆæœ¬: ${{ github.sha }}"
          echo "éƒ¨ç½²ç±»å‹: ${{ github.event.inputs.deploy_type || 'rolling' }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥"
          echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶å¤„ç†é—®é¢˜"
        fi

  # éƒ¨ç½²éªŒè¯æµ‹è¯• (éœ€è¦é…ç½®æœåŠ¡å™¨åŸŸå)
  deployment-verification:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-to-server
    if: false  # æš‚æ—¶ç¦ç”¨ï¼Œéœ€è¦é…ç½®SERVER_DOMAIN secret
    
    steps:
    - name: Run deployment verification tests
      run: |
        # ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
        sleep 60
        
        echo "ğŸ§ª å¼€å§‹éƒ¨ç½²éªŒè¯æµ‹è¯•..."
        
        # åŸºæœ¬è¿æ¥æµ‹è¯•
        if curl -f -s "http://${{ secrets.SERVER_DOMAIN }}/health"; then
          echo "âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸"
        else
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
        # API ç«¯ç‚¹æµ‹è¯•
        if curl -f -s "http://${{ secrets.SERVER_DOMAIN }}/api/v2/system/info"; then
          echo "âœ… API ç«¯ç‚¹æ­£å¸¸"
        else
          echo "âŒ API ç«¯ç‚¹å¼‚å¸¸"
          exit 1
        fi
        
        echo "ğŸ‰ éƒ¨ç½²éªŒè¯æµ‹è¯•é€šè¿‡ï¼"