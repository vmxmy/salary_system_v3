name: Deploy to Private Server

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      deploy_type:
        description: 'éƒ¨ç½²ç±»å‹'
        required: true
        default: 'rolling'
        type: choice
        options:
        - rolling    # æ»šåŠ¨éƒ¨ç½²
        - blue_green # è“ç»¿éƒ¨ç½²
        - canary     # é‡‘ä¸é›€éƒ¨ç½²

env:
  NODE_VERSION: '20'
  APP_NAME: 'salary-system-v3'

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Run tests
      working-directory: ./frontend
      run: |
        npm run lint
        npx tsc --noEmit
        
    - name: Build application for production
      working-directory: ./frontend
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        NODE_ENV: production
      run: |
        echo "ğŸ—ï¸  å¼€å§‹æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
        npm run build
        
        # æ˜¾ç¤ºæ„å»ºç»“æœä¿¡æ¯
        echo "ğŸ“¦ æ„å»ºå®Œæˆï¼Œæ–‡ä»¶ç»Ÿè®¡:"
        ls -la dist/
        du -sh dist/
        find dist/ -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
          
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: frontend/dist/
        retention-days: 7
          
  # éƒ¨ç½²åˆ°ç§æœ‰æœåŠ¡å™¨ - é™æ€æ–‡ä»¶éƒ¨ç½²
  deploy-to-server:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: build-and-test
    if: true   # âœ… å·²é…ç½®SSHå‡­æ®ï¼Œå¯ç”¨é™æ€æ–‡ä»¶éƒ¨ç½²
    
    # âœ… ä½¿ç”¨ github-pages Environment secrets
    environment: 
      name: github-pages
      
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./dist
        
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        
    - name: Validate deployment configuration
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²é…ç½®..."
        
        # æ£€æŸ¥å¿…è¦çš„ Secrets
        if [ -z "${{ secrets.SSH_USER }}" ]; then
          echo "âŒ SSH_USER secret æœªé…ç½®"
          exit 1
        fi
        
        if [ -z "${{ secrets.SSH_HOST }}" ]; then
          echo "âŒ SSH_HOST secret æœªé…ç½®"  
          exit 1
        fi
        
        if [ -z "${{ secrets.SERVER_WEB_ROOT }}" ]; then
          echo "âŒ SERVER_WEB_ROOT secret æœªé…ç½®ï¼ˆå¦‚ï¼š/var/www/htmlï¼‰"
          exit 1
        fi
        
        echo "âœ… SSH é…ç½®éªŒè¯é€šè¿‡"
        echo "ç”¨æˆ·: ${{ secrets.SSH_USER }}"
        echo "ä¸»æœº: ${{ secrets.SSH_HOST }}"
        echo "éƒ¨ç½²è·¯å¾„: ${{ secrets.SERVER_WEB_ROOT }}"
        
        # æ˜¾ç¤ºæ„å»ºæ–‡ä»¶ä¿¡æ¯
        echo ""
        echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²çš„æ–‡ä»¶:"
        ls -la ./dist/
        echo "æ€»å¤§å°: $(du -sh ./dist/ | cut -f1)"
        
    # å¥åº·æ£€æŸ¥ - éƒ¨ç½²å‰
    - name: Pre-deployment health check
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²å‰å¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          if [ "$disk_usage" -gt 85 ]; then
            echo "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼š${disk_usage}%"
            exit 1
          fi
          echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨ç‡ï¼š${disk_usage}%"
          
          # æ£€æŸ¥å†…å­˜
          memory_free=$(free | awk '/^Mem:/ {printf "%.1f", (($2-$3)/$2)*100}')
          echo "ğŸ’¾ å¯ç”¨å†…å­˜ï¼š${memory_free}%"
          
          # æ£€æŸ¥ Web æœåŠ¡å™¨è¿›ç¨‹ï¼ˆApache/Nginxï¼‰
          if pgrep -x "nginx" > /dev/null || pgrep -x "apache2" > /dev/null || pgrep -x "httpd" > /dev/null; then
            echo "âœ… Web æœåŠ¡å™¨è¿è¡Œæ­£å¸¸"
          else
            echo "âš ï¸  æœªæ£€æµ‹åˆ° Web æœåŠ¡å™¨è¿›ç¨‹ï¼Œè¯·ç¡®ä¿å·²å®‰è£…å¹¶è¿è¡Œ"
          fi
          
          echo "âœ… æœåŠ¡å™¨çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²"
        EOF
        
    # åˆ›å»ºéƒ¨ç½²ç›®å½•å’Œå¤‡ä»½
    - name: Prepare deployment directory
      env:
        WEB_ROOT: ${{ secrets.SERVER_WEB_ROOT }}
        DEPLOY_TYPE: ${{ github.event.inputs.deploy_type || 'rolling' }}
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ“ å‡†å¤‡éƒ¨ç½²ç›®å½•..."
          
          # è®¾ç½®å˜é‡
          WEB_ROOT="${{ secrets.SERVER_WEB_ROOT }}"
          BACKUP_DIR="/opt/backups/salary-system/$(date +%Y%m%d_%H%M%S)"
          
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          mkdir -p $BACKUP_DIR
          chown -R ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} /opt/backups/salary-system/ 2>/dev/null || echo "å¤‡ä»½ç›®å½•æƒé™è®¾ç½®å®Œæˆ"
          
          # å¤‡ä»½å½“å‰ç½‘ç«™æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "$WEB_ROOT" ] && [ "$(ls -A $WEB_ROOT 2>/dev/null)" ]; then
            echo "ğŸ’¾ å¤‡ä»½å½“å‰ç½‘ç«™æ–‡ä»¶åˆ°: $BACKUP_DIR"
            cp -r $WEB_ROOT/* $BACKUP_DIR/ || echo "âš ï¸  å¤‡ä»½è¿‡ç¨‹ä¸­é‡åˆ°ä¸€äº›è­¦å‘Šï¼Œç»§ç»­æ‰§è¡Œ"
            echo "BACKUP_DIR=$BACKUP_DIR" >> /tmp/deploy_env
          else
            echo "â„¹ï¸  æ²¡æœ‰å‘ç°ç°æœ‰æ–‡ä»¶ï¼Œè·³è¿‡å¤‡ä»½"
          fi
          
          # ç¡®ä¿ Web æ ¹ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æ­£ç¡®æƒé™
          mkdir -p $WEB_ROOT
          chown -R ${{ secrets.SSH_USER }}:www-data $WEB_ROOT 2>/dev/null || chown -R ${{ secrets.SSH_USER }}:apache $WEB_ROOT 2>/dev/null || chown -R ${{ secrets.SSH_USER }} $WEB_ROOT
          chmod -R 755 $WEB_ROOT
          
          echo "âœ… ç›®å½•å‡†å¤‡å®Œæˆ"
        EOF
        
    # éƒ¨ç½²é™æ€æ–‡ä»¶
    - name: Deploy static files
      env:
        WEB_ROOT: ${{ secrets.SERVER_WEB_ROOT }}
        DEPLOY_TYPE: ${{ github.event.inputs.deploy_type || 'rolling' }}
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²é™æ€æ–‡ä»¶..."
        echo "éƒ¨ç½²ç±»å‹: $DEPLOY_TYPE"
        echo "ç›®æ ‡è·¯å¾„: $WEB_ROOT"
        
        if [ "$DEPLOY_TYPE" = "blue_green" ]; then
          # è“ç»¿éƒ¨ç½²ï¼šå…ˆéƒ¨ç½²åˆ°ä¸´æ—¶ç›®å½•ï¼Œç„¶ååŸå­åˆ‡æ¢
          echo "ğŸ’™ğŸ’š ä½¿ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥"
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            TEMP_DIR="$HOME/temp_deploy_$(date +%Y%m%d_%H%M%S)"
            mkdir -p $TEMP_DIR
            echo "TEMP_DIR=$TEMP_DIR" >> /tmp/deploy_env
            echo $TEMP_DIR
          EOF
          
          # è·å–ä¸´æ—¶ç›®å½•è·¯å¾„å¹¶å¤åˆ¶æ–‡ä»¶
          TEMP_DIR=$(ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'source /tmp/deploy_env && echo $TEMP_DIR')
          scp -r ./dist/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$TEMP_DIR/
          
          # åŸå­åˆ‡æ¢
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            source /tmp/deploy_env
            rm -rf ${{ secrets.SERVER_WEB_ROOT }}/*
            cp -r $TEMP_DIR/* ${{ secrets.SERVER_WEB_ROOT }}/
            chown -R ${{ secrets.SSH_USER }}:www-data ${{ secrets.SERVER_WEB_ROOT }} 2>/dev/null || chown -R ${{ secrets.SSH_USER }}:apache ${{ secrets.SERVER_WEB_ROOT }} 2>/dev/null || chown -R ${{ secrets.SSH_USER }} ${{ secrets.SERVER_WEB_ROOT }}
            chmod -R 755 ${{ secrets.SERVER_WEB_ROOT }}
            rm -rf $TEMP_DIR
            echo "âœ… è“ç»¿éƒ¨ç½²å®Œæˆ"
          EOF
          
        else
          # æ»šåŠ¨éƒ¨ç½²ï¼šç›´æ¥æ›¿æ¢æ–‡ä»¶
          echo "ğŸ”„ ä½¿ç”¨æ»šåŠ¨éƒ¨ç½²ç­–ç•¥"
          
          # æ¸…ç†ç›®æ ‡ç›®å½•
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "ğŸ§¹ æ¸…ç†ç›®æ ‡ç›®å½•..."
            find ${{ secrets.SERVER_WEB_ROOT }} -mindepth 1 -delete 2>/dev/null || echo "ç›®å½•å·²æ¸…ç©º"
          EOF
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          echo "ğŸ“¦ å¤åˆ¶æ–°æ–‡ä»¶..."
          scp -r ./dist/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SERVER_WEB_ROOT }}/
          
          # è®¾ç½®æƒé™
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "ğŸ” è®¾ç½®æ–‡ä»¶æƒé™..."
            chown -R ${{ secrets.SSH_USER }}:www-data ${{ secrets.SERVER_WEB_ROOT }} 2>/dev/null || chown -R ${{ secrets.SSH_USER }}:apache ${{ secrets.SERVER_WEB_ROOT }} 2>/dev/null || chown -R ${{ secrets.SSH_USER }} ${{ secrets.SERVER_WEB_ROOT }}
            chmod -R 755 ${{ secrets.SERVER_WEB_ROOT }}
            find ${{ secrets.SERVER_WEB_ROOT }} -type f -exec chmod 644 {} \;
            echo "âœ… æ»šåŠ¨éƒ¨ç½²å®Œæˆ"
          EOF
        fi
        
    # é‡å¯/é‡è½½ Web æœåŠ¡å™¨
    - name: Reload web server
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ”„ é‡è½½ Web æœåŠ¡å™¨é…ç½®..."
          
          # å°è¯•é‡è½½ Nginx
          if command -v nginx >/dev/null 2>&1; then
            echo "ğŸ“‹ æ£€æµ‹åˆ° Nginxï¼Œå°è¯•é‡è½½é…ç½®..."
            sudo nginx -t && sudo systemctl reload nginx || echo "âš ï¸  Nginx é‡è½½å¤±è´¥"
            echo "âœ… Nginx çŠ¶æ€: $(systemctl is-active nginx)"
          fi
          
          # å°è¯•é‡è½½ Apache
          if command -v apache2 >/dev/null 2>&1; then
            echo "ğŸ“‹ æ£€æµ‹åˆ° Apache2ï¼Œå°è¯•é‡è½½é…ç½®..."
            sudo apache2ctl configtest && sudo systemctl reload apache2 || echo "âš ï¸  Apache2 é‡è½½å¤±è´¥"
            echo "âœ… Apache2 çŠ¶æ€: $(systemctl is-active apache2)"
          elif command -v httpd >/dev/null 2>&1; then
            echo "ğŸ“‹ æ£€æµ‹åˆ° httpdï¼Œå°è¯•é‡è½½é…ç½®..."
            sudo httpd -t && sudo systemctl reload httpd || echo "âš ï¸  httpd é‡è½½å¤±è´¥"
            echo "âœ… httpd çŠ¶æ€: $(systemctl is-active httpd)"
          fi
          
          echo "ğŸ¯ Web æœåŠ¡å™¨é‡è½½å®Œæˆ"
        EOF
        
    # éƒ¨ç½²åå¥åº·æ£€æŸ¥
    - name: Post-deployment health check
      env:
        WEB_ROOT: ${{ secrets.SERVER_WEB_ROOT }}
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          echo "ğŸ” æ‰§è¡Œéƒ¨ç½²åå¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸéƒ¨ç½²
          if [ ! -f "$WEB_ROOT/index.html" ]; then
            echo "âŒ index.html æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéƒ¨ç½²å¯èƒ½å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸»æ–‡ä»¶å­˜åœ¨æ£€æŸ¥é€šè¿‡"
          
          # æ˜¾ç¤ºéƒ¨ç½²çš„æ–‡ä»¶ç»Ÿè®¡
          echo "ğŸ“Š éƒ¨ç½²æ–‡ä»¶ç»Ÿè®¡:"
          find $WEB_ROOT -type f | wc -l | xargs echo "æ–‡ä»¶æ€»æ•°:"
          du -sh $WEB_ROOT | cut -f1 | xargs echo "æ€»å¤§å°:"
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          echo "ğŸ“‹ å…³é”®æ–‡ä»¶æ£€æŸ¥:"
          for file in index.html assets/index-*.js assets/index-*.css; do
            if find $WEB_ROOT -path "*\$file" | head -1 | read; then
              echo "âœ… æ‰¾åˆ°: \$file"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°: \$file"  
            fi
          done
        EOF
        
        # å°è¯• HTTP å¥åº·æ£€æŸ¥ï¼ˆå¦‚æœé…ç½®äº†åŸŸåï¼‰
        if [ -n "${{ secrets.SERVER_DOMAIN }}" ]; then
          echo "ğŸŒ å°è¯• HTTP å¥åº·æ£€æŸ¥..."
          
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "å°è¯•ç¬¬ $attempt æ¬¡ HTTP æ£€æŸ¥..."
            
            if curl -f -s -I "http://${{ secrets.SERVER_DOMAIN }}" | head -1 | grep -q "200"; then
              echo "âœ… HTTP å¥åº·æ£€æŸ¥é€šè¿‡"
              curl -I "http://${{ secrets.SERVER_DOMAIN }}"
              break
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âš ï¸  HTTP æ£€æŸ¥æœªé€šè¿‡ï¼Œä½†ä¸å½±å“éƒ¨ç½²ç»“æœ"
              echo "è¯·æ‰‹åŠ¨æ£€æŸ¥ç½‘ç«™ï¼šhttp://${{ secrets.SERVER_DOMAIN }}"
            fi
            
            sleep 5
            attempt=$((attempt + 1))
          done
        else
          echo "â„¹ï¸  æœªé…ç½® SERVER_DOMAINï¼Œè·³è¿‡ HTTP æ£€æŸ¥"
        fi
        
        echo "ğŸ‰ éƒ¨ç½²å¥åº·æ£€æŸ¥å®Œæˆï¼"
        
    # æ¸…ç†æ—§ç‰ˆæœ¬å¤‡ä»½
    - name: Cleanup old backups
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬å¤‡ä»½..."
          
          BACKUP_BASE="/opt/backups/salary-system"
          
          if [ -d "$BACKUP_BASE" ]; then
            # ä¿ç•™æœ€è¿‘ 5 ä¸ªå¤‡ä»½ï¼Œåˆ é™¤å…¶ä»–çš„
            cd $BACKUP_BASE
            ls -t | tail -n +6 | xargs rm -rf 2>/dev/null || echo "æ²¡æœ‰æ—§å¤‡ä»½éœ€è¦æ¸…ç†"
            
            remaining=$(ls | wc -l)
            echo "âœ… æ¸…ç†å®Œæˆï¼Œä¿ç•™ $remaining ä¸ªå¤‡ä»½"
          else
            echo "â„¹ï¸  æ²¡æœ‰å¤‡ä»½ç›®å½•éœ€è¦æ¸…ç†"
          fi
        EOF
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸš€ é™æ€æ–‡ä»¶éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
          echo "ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"
          echo "ç‰ˆæœ¬: ${{ github.sha }}"
          echo "éƒ¨ç½²ç±»å‹: ${{ github.event.inputs.deploy_type || 'rolling' }}"
          echo "ç›®æ ‡è·¯å¾„: ${{ secrets.SERVER_WEB_ROOT }}"
          echo "éƒ¨ç½²æ—¶é—´: $(date)"
          echo ""
          if [ -n "${{ secrets.SERVER_DOMAIN }}" ]; then
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_DOMAIN }}"
          else
            echo "ğŸ’¡ è¯·é…ç½® SERVER_DOMAIN secret ä»¥ä¾¿æ˜¾ç¤ºè®¿é—®åœ°å€"
          fi
        else
          echo "âŒ é™æ€æ–‡ä»¶éƒ¨ç½²å¤±è´¥ï¼"
          echo ""
          echo "ğŸ”§ æ•…éšœæ’é™¤å»ºè®®ï¼š"
          echo "1. æ£€æŸ¥ SSH è¿æ¥æ˜¯å¦æ­£å¸¸"
          echo "2. éªŒè¯æœåŠ¡å™¨æƒé™é…ç½®"
          echo "3. ç¡®è®¤ SERVER_WEB_ROOT è·¯å¾„æ­£ç¡®"
          echo "4. æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³"
          echo "5. æŸ¥çœ‹è¯¦ç»†éƒ¨ç½²æ—¥å¿—"
        fi