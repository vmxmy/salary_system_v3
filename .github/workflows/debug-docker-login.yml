name: Debug Docker Login

on:
  workflow_dispatch:

jobs:
  debug-docker-login:
    name: Debug Docker Hub Login
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # æ£€æŸ¥ secrets æ˜¯å¦å­˜åœ¨ï¼ˆä¸ä¼šæ³„éœ²å®é™…å€¼ï¼‰
    - name: Check Docker Hub secrets
      run: |
        echo "ğŸ” æ£€æŸ¥ Docker Hub Secrets..."
        
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "âŒ DOCKER_USERNAME secret æœªè®¾ç½®"
          echo "è¯·åœ¨ GitHub Settings > Secrets ä¸­æ·»åŠ  DOCKER_USERNAME"
        else
          echo "âœ… DOCKER_USERNAME secret å·²è®¾ç½®"
          echo "ç”¨æˆ·åé•¿åº¦: $(echo '${{ secrets.DOCKER_USERNAME }}' | wc -c)"
        fi
        
        if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "âŒ DOCKER_PASSWORD secret æœªè®¾ç½®"
          echo "è¯·åœ¨ GitHub Settings > Secrets ä¸­æ·»åŠ  DOCKER_PASSWORD"
        else
          echo "âœ… DOCKER_PASSWORD secret å·²è®¾ç½®"
          echo "å¯†ç /ä»¤ç‰Œé•¿åº¦: $(echo '${{ secrets.DOCKER_PASSWORD }}' | wc -c)"
        fi
        
    # æµ‹è¯•ç½‘ç»œè¿æ¥
    - name: Test Docker Hub connectivity
      run: |
        echo "ğŸŒ æµ‹è¯• Docker Hub è¿æ¥..."
        
        # æµ‹è¯•ç½‘ç»œè¿æ¥
        if ping -c 3 hub.docker.com; then
          echo "âœ… Docker Hub ç½‘ç»œè¿æ¥æ­£å¸¸"
        else
          echo "âŒ Docker Hub ç½‘ç»œè¿æ¥å¤±è´¥"
        fi
        
        # æµ‹è¯• Docker Hub API
        if curl -f -s https://hub.docker.com/v2/users/login/ > /dev/null; then
          echo "âœ… Docker Hub API å¯è®¿é—®"
        else
          echo "âŒ Docker Hub API è®¿é—®å¤±è´¥"
        fi
        
    # è®¾ç½® Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    # å°è¯•ç™»å½•ï¼ˆä½¿ç”¨è¯¦ç»†æ—¥å¿—ï¼‰
    - name: Test Docker Hub login with debug
      env:
        DOCKER_CLI_EXPERIMENTAL: enabled
        BUILDX_CONFIG: /tmp/.buildx
      run: |
        echo "ğŸ”‘ æµ‹è¯• Docker Hub ç™»å½•..."
        
        # å¯ç”¨è°ƒè¯•æ¨¡å¼
        export ACTIONS_STEP_DEBUG=true
        
        # æ˜¾ç¤º Docker ç‰ˆæœ¬ä¿¡æ¯
        docker version
        docker info
        
        # å°è¯•ç™»å½•ï¼ˆä¸æ˜¾ç¤ºå‡­æ®ï¼‰
        echo "æ­£åœ¨å°è¯•ç™»å½•åˆ° Docker Hub..."
        
    - name: Login to Docker Hub (with error handling)
      id: docker-login
      continue-on-error: true
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    # æ£€æŸ¥ç™»å½•ç»“æœ
    - name: Check login result
      run: |
        if [ "${{ steps.docker-login.outcome }}" = "success" ]; then
          echo "âœ… Docker Hub ç™»å½•æˆåŠŸ!"
          
          # æµ‹è¯•æ¨é€æƒé™
          echo "æµ‹è¯•æ¨é€æƒé™..."
          docker pull hello-world
          docker tag hello-world ${{ secrets.DOCKER_USERNAME }}/test-login:latest
          
          if docker push ${{ secrets.DOCKER_USERNAME }}/test-login:latest; then
            echo "âœ… æ¨é€æƒé™æ­£å¸¸"
            # æ¸…ç†æµ‹è¯•é•œåƒ
            docker rmi ${{ secrets.DOCKER_USERNAME }}/test-login:latest || true
          else
            echo "âŒ æ¨é€æƒé™å¼‚å¸¸"
          fi
          
        else
          echo "âŒ Docker Hub ç™»å½•å¤±è´¥!"
          echo "å¸¸è§è§£å†³æ–¹æ¡ˆ:"
          echo "1. æ£€æŸ¥ DOCKER_USERNAME æ˜¯å¦æ­£ç¡®"
          echo "2. ç¡®è®¤ DOCKER_PASSWORD ä½¿ç”¨çš„æ˜¯è®¿é—®ä»¤ç‰Œï¼Œä¸æ˜¯å¯†ç "
          echo "3. æ£€æŸ¥ Docker Hub è´¦æˆ·æ˜¯å¦è¢«é”å®š"
          echo "4. éªŒè¯è®¿é—®ä»¤ç‰Œæƒé™æ˜¯å¦è¶³å¤Ÿ"
        fi
        
    # æ˜¾ç¤ºæœ‰ç”¨çš„è°ƒè¯•ä¿¡æ¯
    - name: Debug information
      if: always()
      run: |
        echo "ğŸ”§ è°ƒè¯•ä¿¡æ¯:"
        echo "Docker ç‰ˆæœ¬: $(docker version --format '{{.Client.Version}}')"
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "GitHub Runner: ${{ runner.os }}"
        echo "å·¥ä½œæµè§¦å‘äº‹ä»¶: ${{ github.event_name }}"