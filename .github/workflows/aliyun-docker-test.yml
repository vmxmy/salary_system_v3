name: Aliyun Docker Registry Test

on:
  workflow_dispatch:
    inputs:
      registry_type:
        description: 'æµ‹è¯•çš„ä»“åº“ç±»å‹'
        required: true
        default: 'aliyun'
        type: choice
        options:
        - aliyun       # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        - dockerhub    # Docker Hub
        - both         # ä¸¤ç§éƒ½æµ‹è¯•

env:
  TEST_IMAGE_NAME: 'hello-world-test'

jobs:
  test-aliyun-registry:
    name: é˜¿é‡Œäº‘ Docker ä»“åº“æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: æ˜¾ç¤ºæµ‹è¯•é…ç½®
      run: |
        echo "ğŸ§ª Docker ä»“åº“ç™»å½•æµ‹è¯•"
        echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.registry_type }}"
        echo "æ—¶é—´: $(date)"
        echo ""
        
        echo "ğŸ“‹ é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡é…ç½®è¯´æ˜:"
        echo "1. ç™»å½• https://cr.console.aliyun.com/"
        echo "2. åˆ›å»ºå‘½åç©ºé—´ï¼ˆå¦‚ï¼šsalary-systemï¼‰"
        echo "3. è·å–ç™»å½•å‡­æ®"
        echo "4. åœ¨ GitHub Settings > Secrets ä¸­æ·»åŠ :"
        echo "   - ALIYUN_REGISTRY_USERNAME: é˜¿é‡Œäº‘ç”¨æˆ·å"
        echo "   - ALIYUN_REGISTRY_PASSWORD: é˜¿é‡Œäº‘å¯†ç "
        echo "5. å¯é€‰ï¼šåœ¨ Variables ä¸­æ·»åŠ  ALIYUN_REGISTRY (é»˜è®¤: registry.cn-beijing.aliyuncs.com)"
        echo ""
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: æ£€æŸ¥é˜¿é‡Œäº‘é…ç½®
      if: github.event.inputs.registry_type == 'aliyun' || github.event.inputs.registry_type == 'both'
      run: |
        echo "ğŸ” æ£€æŸ¥é˜¿é‡Œäº‘ä»“åº“é…ç½®..."
        
        if [ -n "${{ secrets.ALIYUN_REGISTRY_USERNAME }}" ]; then
          echo "âœ… ALIYUN_REGISTRY_USERNAME å·²é…ç½®"
          echo "ç”¨æˆ·å: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}"
        else
          echo "âŒ ALIYUN_REGISTRY_USERNAME æœªé…ç½®"
        fi
        
        if [ -n "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" ]; then
          echo "âœ… ALIYUN_REGISTRY_PASSWORD å·²é…ç½®"
          echo "å¯†ç é•¿åº¦: $(echo '${{ secrets.ALIYUN_REGISTRY_PASSWORD }}' | wc -c)"
        else
          echo "âŒ ALIYUN_REGISTRY_PASSWORD æœªé…ç½®"
        fi
        
        REGISTRY="${{ vars.ALIYUN_REGISTRY || 'registry.cn-beijing.aliyuncs.com' }}"
        echo "Registry URL: $REGISTRY"
        
        # æµ‹è¯•ç½‘ç»œè¿æ¥
        if ping -c 3 registry.cn-beijing.aliyuncs.com; then
          echo "âœ… é˜¿é‡Œäº‘ä»“åº“ç½‘ç»œè¿æ¥æ­£å¸¸"
        else
          echo "âš ï¸  é˜¿é‡Œäº‘ä»“åº“ç½‘ç»œè¿æ¥å¼‚å¸¸"
        fi
        
    - name: ç™»å½•é˜¿é‡Œäº‘ Docker ä»“åº“
      if: github.event.inputs.registry_type == 'aliyun' || github.event.inputs.registry_type == 'both'
      id: aliyun-login
      continue-on-error: true
      uses: docker/login-action@v3
      with:
        registry: ${{ vars.ALIYUN_REGISTRY || 'registry.cn-beijing.aliyuncs.com' }}
        username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
        password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
        
    - name: æ£€æŸ¥ Docker Hub é…ç½®
      if: github.event.inputs.registry_type == 'dockerhub' || github.event.inputs.registry_type == 'both'
      run: |
        echo "ğŸ” æ£€æŸ¥ Docker Hub é…ç½®..."
        
        if [ -n "${{ vars.DOCKERHUB_USERNAME }}" ] || [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "âœ… Docker Hub ç”¨æˆ·åå·²é…ç½®"
        else
          echo "âŒ Docker Hub ç”¨æˆ·åæœªé…ç½®"
        fi
        
        if [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ] || [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "âœ… Docker Hub ä»¤ç‰Œå·²é…ç½®"
        else
          echo "âŒ Docker Hub ä»¤ç‰Œæœªé…ç½®"
        fi
        
        # æµ‹è¯•ç½‘ç»œè¿æ¥
        if ping -c 3 hub.docker.com; then
          echo "âœ… Docker Hub ç½‘ç»œè¿æ¥æ­£å¸¸"
        else
          echo "âš ï¸  Docker Hub ç½‘ç»œè¿æ¥å¼‚å¸¸"
        fi
        
    - name: ç™»å½• Docker Hub
      if: github.event.inputs.registry_type == 'dockerhub' || github.event.inputs.registry_type == 'both'
      id: dockerhub-login
      continue-on-error: true
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME || secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN || secrets.DOCKER_PASSWORD }}
        
    - name: æµ‹è¯•é•œåƒæ¨é€ï¼ˆé˜¿é‡Œäº‘ï¼‰
      if: steps.aliyun-login.outcome == 'success'
      run: |
        echo "ğŸš€ æµ‹è¯•é˜¿é‡Œäº‘ä»“åº“æ¨é€..."
        
        REGISTRY="${{ vars.ALIYUN_REGISTRY || 'registry.cn-beijing.aliyuncs.com' }}"
        USERNAME="${{ secrets.ALIYUN_REGISTRY_USERNAME }}"
        IMAGE_TAG="$REGISTRY/$USERNAME/$TEST_IMAGE_NAME:test"
        
        # æ‹‰å–æµ‹è¯•é•œåƒ
        docker pull hello-world
        
        # æ ‡è®°ä¸ºé˜¿é‡Œäº‘é•œåƒ
        docker tag hello-world $IMAGE_TAG
        
        # æ¨é€åˆ°é˜¿é‡Œäº‘
        if docker push $IMAGE_TAG; then
          echo "âœ… é˜¿é‡Œäº‘ä»“åº“æ¨é€æˆåŠŸ"
          echo "é•œåƒåœ°å€: $IMAGE_TAG"
          
          # æ¸…ç†æœ¬åœ°é•œåƒ
          docker rmi $IMAGE_TAG || true
        else
          echo "âŒ é˜¿é‡Œäº‘ä»“åº“æ¨é€å¤±è´¥"
        fi
        
    - name: æµ‹è¯•é•œåƒæ¨é€ï¼ˆDocker Hubï¼‰
      if: steps.dockerhub-login.outcome == 'success'
      run: |
        echo "ğŸš€ æµ‹è¯• Docker Hub æ¨é€..."
        
        USERNAME="${{ vars.DOCKERHUB_USERNAME || secrets.DOCKER_USERNAME }}"
        IMAGE_TAG="$USERNAME/$TEST_IMAGE_NAME:test"
        
        # æ‹‰å–æµ‹è¯•é•œåƒ
        docker pull hello-world
        
        # æ ‡è®°ä¸º Docker Hub é•œåƒ
        docker tag hello-world $IMAGE_TAG
        
        # æ¨é€åˆ° Docker Hub
        if docker push $IMAGE_TAG; then
          echo "âœ… Docker Hub æ¨é€æˆåŠŸ"
          echo "é•œåƒåœ°å€: $IMAGE_TAG"
          
          # æ¸…ç†æœ¬åœ°é•œåƒ
          docker rmi $IMAGE_TAG || true
        else
          echo "âŒ Docker Hub æ¨é€å¤±è´¥"
        fi
        
    - name: æµ‹è¯•ç»“æœæ€»ç»“
      if: always()
      run: |
        echo "ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“:"
        echo "==================="
        
        if [ "${{ steps.aliyun-login.outcome }}" = "success" ]; then
          echo "âœ… é˜¿é‡Œäº‘ä»“åº“: ç™»å½•æˆåŠŸ"
        elif [ "${{ steps.aliyun-login.outcome }}" = "failure" ]; then
          echo "âŒ é˜¿é‡Œäº‘ä»“åº“: ç™»å½•å¤±è´¥"
        fi
        
        if [ "${{ steps.dockerhub-login.outcome }}" = "success" ]; then
          echo "âœ… Docker Hub: ç™»å½•æˆåŠŸ"
        elif [ "${{ steps.dockerhub-login.outcome }}" = "failure" ]; then
          echo "âŒ Docker Hub: ç™»å½•å¤±è´¥"
        fi
        
        echo ""
        echo "ğŸ’¡ å»ºè®®:"
        if [ "${{ steps.aliyun-login.outcome }}" = "success" ]; then
          echo "- é˜¿é‡Œäº‘ä»“åº“å·¥ä½œæ­£å¸¸ï¼Œæ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨"
          echo "- é˜¿é‡Œäº‘ä»“åº“åœ¨ä¸­å›½å¢ƒå†…ç½‘ç»œè¿æ¥æ›´ç¨³å®š"
        else
          echo "- å¦‚éœ€ä½¿ç”¨é˜¿é‡Œäº‘ä»“åº“ï¼Œè¯·æ£€æŸ¥é…ç½®å¹¶é‡è¯•"
        fi
        
        if [ "${{ steps.dockerhub-login.outcome }}" != "success" ]; then
          echo "- Docker Hub è¿æ¥å­˜åœ¨é—®é¢˜ï¼Œå»ºè®®åˆ‡æ¢åˆ°é˜¿é‡Œäº‘ä»“åº“"
        fi
        
    - name: æ¸…ç†æµ‹è¯•é•œåƒ
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æµ‹è¯•é•œåƒ..."
        docker rmi hello-world || true
        docker system prune -f || true