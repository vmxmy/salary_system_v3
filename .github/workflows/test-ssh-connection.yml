name: Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Test SSH Connection and Secrets
    runs-on: ubuntu-latest
    
    environment: 
      name: production  # 使用 production 环境访问 Environment secrets
      
    steps:
    - name: Test Environment Secrets
      run: |
        echo "🔍 测试 Environment Secrets 访问..."
        
        # 检查所有必需的 secrets（不显示实际值）
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "❌ SSH_PRIVATE_KEY 未找到"
        else
          echo "✅ SSH_PRIVATE_KEY 存在 (长度: $(echo '${{ secrets.SSH_PRIVATE_KEY }}' | wc -c))"
        fi
        
        if [ -z "${{ secrets.SSH_USER }}" ]; then
          echo "❌ SSH_USER 未找到"
        else
          echo "✅ SSH_USER 存在: ${{ secrets.SSH_USER }}"
        fi
        
        if [ -z "${{ secrets.SSH_HOST }}" ]; then
          echo "❌ SSH_HOST 未找到"
        else
          echo "✅ SSH_HOST 存在: ${{ secrets.SSH_HOST }}"
        fi
        
        if [ -z "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
          echo "❌ SSH_KNOWN_HOSTS 未找到"
        else
          echo "✅ SSH_KNOWN_HOSTS 存在"
        fi
        
        if [ -z "${{ secrets.SERVER_WEB_ROOT }}" ]; then
          echo "❌ SERVER_WEB_ROOT 未找到"
        else
          echo "✅ SERVER_WEB_ROOT 存在: ${{ secrets.SERVER_WEB_ROOT }}"
        fi
        
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        
    - name: Test SSH Connection
      run: |
        echo "🔗 测试 SSH 连接..."
        
        # 测试基本连接
        if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH连接成功！'"; then
          echo "✅ SSH 连接测试通过"
        else
          echo "❌ SSH 连接失败"
          exit 1
        fi
        
    - name: Test Server Environment
      run: |
        echo "🖥️  测试服务器环境..."
        
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "服务器信息:"
          echo "- 主机名: $(hostname)"
          echo "- 操作系统: $(uname -a)"
          echo "- 当前用户: $(whoami)"
          echo "- 当前路径: $(pwd)"
          
          echo "检查 Web 根目录:"
          if [ -d "${{ secrets.SERVER_WEB_ROOT }}" ]; then
            echo "✅ Web 根目录存在: ${{ secrets.SERVER_WEB_ROOT }}"
            echo "- 权限: $(ls -ld ${{ secrets.SERVER_WEB_ROOT }})"
            echo "- 可写性测试..."
            if touch "${{ secrets.SERVER_WEB_ROOT }}/test_write.tmp" 2>/dev/null; then
              rm -f "${{ secrets.SERVER_WEB_ROOT }}/test_write.tmp"
              echo "✅ Web 根目录可写"
            else
              echo "⚠️  Web 根目录不可写，可能需要 sudo"
            fi
          else
            echo "❌ Web 根目录不存在: ${{ secrets.SERVER_WEB_ROOT }}"
          fi
          
          echo "检查 Web 服务器:"
          if pgrep -x "nginx" > /dev/null; then
            echo "✅ Nginx 运行中"
          elif pgrep -x "apache2" > /dev/null || pgrep -x "httpd" > /dev/null; then
            echo "✅ Apache 运行中"
          else
            echo "⚠️  未检测到 Web 服务器进程"
          fi
          
          echo "检查磁盘空间:"
          df -h /
        EOF
        
        echo "🎉 服务器环境检查完成！"