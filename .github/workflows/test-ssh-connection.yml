name: Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Test SSH Connection and Secrets
    runs-on: ubuntu-latest
    
    environment: 
      name: production  # ä½¿ç”¨ production ç¯å¢ƒè®¿é—® Environment secrets
      
    steps:
    - name: Test Environment Secrets
      run: |
        echo "ğŸ” æµ‹è¯• Environment Secrets è®¿é—®..."
        
        # æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„ secretsï¼ˆä¸æ˜¾ç¤ºå®é™…å€¼ï¼‰
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ SSH_PRIVATE_KEY æœªæ‰¾åˆ°"
        else
          echo "âœ… SSH_PRIVATE_KEY å­˜åœ¨ (é•¿åº¦: $(echo '${{ secrets.SSH_PRIVATE_KEY }}' | wc -c))"
        fi
        
        if [ -z "${{ secrets.SSH_USER }}" ]; then
          echo "âŒ SSH_USER æœªæ‰¾åˆ°"
        else
          echo "âœ… SSH_USER å­˜åœ¨: ${{ secrets.SSH_USER }}"
        fi
        
        if [ -z "${{ secrets.SSH_HOST }}" ]; then
          echo "âŒ SSH_HOST æœªæ‰¾åˆ°"
        else
          echo "âœ… SSH_HOST å­˜åœ¨: ${{ secrets.SSH_HOST }}"
        fi
        
        if [ -z "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
          echo "âŒ SSH_KNOWN_HOSTS æœªæ‰¾åˆ°"
        else
          echo "âœ… SSH_KNOWN_HOSTS å­˜åœ¨"
        fi
        
        if [ -z "${{ secrets.SERVER_WEB_ROOT }}" ]; then
          echo "âŒ SERVER_WEB_ROOT æœªæ‰¾åˆ°"
        else
          echo "âœ… SERVER_WEB_ROOT å­˜åœ¨: ${{ secrets.SERVER_WEB_ROOT }}"
        fi
        
    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        
    - name: Test SSH Connection
      run: |
        echo "ğŸ”— æµ‹è¯• SSH è¿æ¥..."
        
        # æµ‹è¯•åŸºæœ¬è¿æ¥
        if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSHè¿æ¥æˆåŠŸï¼'"; then
          echo "âœ… SSH è¿æ¥æµ‹è¯•é€šè¿‡"
        else
          echo "âŒ SSH è¿æ¥å¤±è´¥"
          exit 1
        fi
        
    - name: Test Server Environment
      run: |
        echo "ğŸ–¥ï¸  æµ‹è¯•æœåŠ¡å™¨ç¯å¢ƒ..."
        
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          echo "æœåŠ¡å™¨ä¿¡æ¯:"
          echo "- ä¸»æœºå: $(hostname)"
          echo "- æ“ä½œç³»ç»Ÿ: $(uname -a)"
          echo "- å½“å‰ç”¨æˆ·: $(whoami)"
          echo "- å½“å‰è·¯å¾„: $(pwd)"
          
          echo "æ£€æŸ¥ Web æ ¹ç›®å½•:"
          if [ -d "${{ secrets.SERVER_WEB_ROOT }}" ]; then
            echo "âœ… Web æ ¹ç›®å½•å­˜åœ¨: ${{ secrets.SERVER_WEB_ROOT }}"
            echo "- æƒé™: $(ls -ld ${{ secrets.SERVER_WEB_ROOT }})"
            echo "- å¯å†™æ€§æµ‹è¯•..."
            if touch "${{ secrets.SERVER_WEB_ROOT }}/test_write.tmp" 2>/dev/null; then
              rm -f "${{ secrets.SERVER_WEB_ROOT }}/test_write.tmp"
              echo "âœ… Web æ ¹ç›®å½•å¯å†™"
            else
              echo "âš ï¸  Web æ ¹ç›®å½•ä¸å¯å†™ï¼Œå¯èƒ½éœ€è¦ sudo"
            fi
          else
            echo "âŒ Web æ ¹ç›®å½•ä¸å­˜åœ¨: ${{ secrets.SERVER_WEB_ROOT }}"
          fi
          
          echo "æ£€æŸ¥ Web æœåŠ¡å™¨:"
          if pgrep -x "nginx" > /dev/null; then
            echo "âœ… Nginx è¿è¡Œä¸­"
          elif pgrep -x "apache2" > /dev/null || pgrep -x "httpd" > /dev/null; then
            echo "âœ… Apache è¿è¡Œä¸­"
          else
            echo "âš ï¸  æœªæ£€æµ‹åˆ° Web æœåŠ¡å™¨è¿›ç¨‹"
          fi
          
          echo "æ£€æŸ¥ç£ç›˜ç©ºé—´:"
          df -h /
        EOF
        
        echo "ğŸ‰ æœåŠ¡å™¨ç¯å¢ƒæ£€æŸ¥å®Œæˆï¼"