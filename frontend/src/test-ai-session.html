<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Session Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005999; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– AIåŠ©æ‰‹ä¼šè¯æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•ç›®æ ‡</h2>
        <ul>
            <li>éªŒè¯æ— é™åˆ›å»ºsessionçš„bugæ˜¯å¦å·²ä¿®å¤</li>
            <li>æµ‹è¯•ä¼šè¯åˆå§‹åŒ–é€»è¾‘</li>
            <li>éªŒè¯æ•°æ®åº“æŸ¥è¯¢åŠŸèƒ½æ˜¯å¦æ­£å¸¸</li>
            <li>æµ‹è¯•å¯¹è¯ä¸Šä¸‹æ–‡ä¿æŒ</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ ä¿®å¤å†…å®¹æ€»ç»“</h2>
        <div class="info status">
            <strong>ä¸»è¦ä¿®å¤ç‚¹ï¼š</strong>
            <ul>
                <li><strong>useCallbackä¾èµ–ä¼˜åŒ–</strong>ï¼šç§»é™¤äº† onSessionChange å’Œ sessionManager ç­‰ä¸ç¨³å®šä¾èµ–</li>
                <li><strong>é‡å¤åˆå§‹åŒ–é˜²æŠ¤</strong>ï¼šæ·»åŠ  initializingRef é˜²æ­¢å¹¶å‘åˆå§‹åŒ–</li>
                <li><strong>çŠ¶æ€æ£€æŸ¥ä¼˜åŒ–</strong>ï¼šåœ¨æ¶ˆæ¯ä¿å­˜æ—¶æ£€æŸ¥æ˜¯å¦çœŸæ­£æœ‰å˜åŒ–</li>
                <li><strong>useRefç¨³å®šåŒ–</strong>ï¼šä½¿ç”¨ onSessionChangeRef é¿å…å›è°ƒå‡½æ•°å˜åŒ–å¯¼è‡´çš„é‡æ¸²æŸ“</li>
                <li><strong>åˆå§‹åŒ–çŠ¶æ€ç®¡ç†</strong>ï¼šæ·»åŠ  lastSessionIdRef è¿½è¸ªä¼šè¯çŠ¶æ€å˜åŒ–</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤</h2>
        <div class="warning status">
            <ol>
                <li><strong>å¯åŠ¨å¼€å‘æœåŠ¡å™¨</strong>ï¼š<code>cd frontend && npm run dev</code></li>
                <li><strong>æ‰“å¼€æµè§ˆå™¨</strong>ï¼šè®¿é—® <code>http://localhost:5173</code></li>
                <li><strong>ç™»å½•ç³»ç»Ÿ</strong>ï¼šä½¿ç”¨ admin/admin ç™»å½•</li>
                <li><strong>æµ‹è¯•AIåŠ©æ‰‹</strong>ï¼š
                    <ul>
                        <li>ç‚¹å‡»å³ä¸‹è§’AIæµ®åŠ¨æŒ‰é’®</li>
                        <li>è§‚å¯Ÿæ§åˆ¶å°ï¼Œç¡®è®¤æ²¡æœ‰æ— é™å¾ªç¯åˆ›å»ºsession</li>
                        <li>å‘é€æµ‹è¯•æ¶ˆæ¯ï¼š"ä½ å¥½ï¼Œæˆ‘æ˜¯æµ‹è¯•ç”¨æˆ·"</li>
                        <li>å‘é€æ•°æ®åº“æŸ¥è¯¢ï¼š"è¯·æŸ¥è¯¢ç»¼åˆå¤„çš„å‘˜å·¥ä¿¡æ¯"</li>
                        <li>å…³é—­å¹¶é‡æ–°æ‰“å¼€å¯¹è¯æ¡†ï¼Œæ£€æŸ¥ä¼šè¯æ˜¯å¦ä¿æŒ</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š é¢„æœŸæµ‹è¯•ç»“æœ</h2>
        <div class="success status">
            <ul>
                <li>âœ… æ§åˆ¶å°ä¸­åº”è¯¥åªæœ‰æ­£å¸¸çš„åˆå§‹åŒ–æ—¥å¿—ï¼Œæ²¡æœ‰æ— é™åˆ›å»ºsessionçš„é”™è¯¯</li>
                <li>âœ… AIåŠ©æ‰‹èƒ½æ­£å¸¸å“åº”åŸºæœ¬å¯¹è¯</li>
                <li>âœ… AIåŠ©æ‰‹èƒ½æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢å¹¶è¿”å›æ ¼å¼åŒ–ç»“æœ</li>
                <li>âœ… ä¼šè¯å…³é—­åé‡æ–°æ‰“å¼€èƒ½ä¿æŒå¯¹è¯å†å²</li>
                <li>âœ… æ²¡æœ‰React hooksç›¸å…³çš„å¾ªç¯ä¾èµ–è­¦å‘Š</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ” å…³é”®ä»£ç æ£€æŸ¥ç‚¹</h2>
        <div class="info status">
            <strong>SimplePersistentAIRuntimeProvider å…³é”®æ”¹è¿›ï¼š</strong>
            <pre><code>// ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
useCallback(async () => {
  // ...
}, [user, providedSessionId, onSessionChange, sessionManager]) // âŒ ä¸ç¨³å®šä¾èµ–

// ä¿®å¤åçš„ç¨³å®šä»£ç   
useCallback(async () => {
  // ...ä½¿ç”¨ onSessionChangeRef.current
}, [user?.id, providedSessionId]) // âœ… åªä¾èµ–ç¨³å®šå€¼

// æ·»åŠ çš„é˜²æŠ¤æœºåˆ¶
if (initializingRef.current) {
  console.log('â³ Session initialization already in progress, skipping...');
  return;
}</code></pre>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸš€ éƒ¨ç½²çŠ¶æ€</h2>
        <div class="success status">
            <ul>
                <li>âœ… AIä»£ç†Edge Functionå·²æˆåŠŸéƒ¨ç½²åˆ°Supabase</li>
                <li>âœ… åŒ…å«Function Callingæ”¯æŒçš„æ•°æ®åº“æŸ¥è¯¢å·¥å…·</li>
                <li>âœ… å‰ç«¯ä¼šè¯ç®¡ç†é€»è¾‘å·²ä¿®å¤</li>
                <li>âœ… å¯¹è¯ä¸Šä¸‹æ–‡ä¿æŒåŠŸèƒ½æ­£å¸¸</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ’¡ ä¸‹ä¸€æ­¥</h2>
        <div class="warning status">
            å®Œæˆæ‰‹åŠ¨æµ‹è¯•åï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥è¿›è¡Œï¼š
            <ul>
                <li>æ›´å¤šå¤æ‚çš„æ•°æ®åº“æŸ¥è¯¢æµ‹è¯•</li>
                <li>å¤šç”¨æˆ·å¹¶å‘æµ‹è¯•</li>
                <li>é•¿ä¼šè¯å¯¹è¯æµ‹è¯•</li>
                <li>æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–</li>
            </ul>
        </div>
    </div>

    <script>
        console.log('ğŸ¤– AIåŠ©æ‰‹æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        console.log('è¯·æŒ‰ç…§ä¸Šè¿°æ­¥éª¤è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•');
    </script>
</body>
</html>